{
  "url": "https://api.github.com/repos/openclaw/openclaw/issues/11551",
  "repository_url": "https://api.github.com/repos/openclaw/openclaw",
  "labels_url": "https://api.github.com/repos/openclaw/openclaw/issues/11551/labels{/name}",
  "comments_url": "https://api.github.com/repos/openclaw/openclaw/issues/11551/comments",
  "events_url": "https://api.github.com/repos/openclaw/openclaw/issues/11551/events",
  "html_url": "https://github.com/openclaw/openclaw/pull/11551",
  "id": 3911635325,
  "node_id": "PR_kwDOQb6kR87CPkZs",
  "number": 11551,
  "title": "Subagents: stabilize announce/compaction stats and cap impossible context usage tokens",
  "user": {
    "login": "tyler6204",
    "id": 64381258,
    "node_id": "MDQ6VXNlcjY0MzgxMjU4",
    "avatar_url": "https://avatars.githubusercontent.com/u/64381258?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tyler6204",
    "html_url": "https://github.com/tyler6204",
    "followers_url": "https://api.github.com/users/tyler6204/followers",
    "following_url": "https://api.github.com/users/tyler6204/following{/other_user}",
    "gists_url": "https://api.github.com/users/tyler6204/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tyler6204/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tyler6204/subscriptions",
    "organizations_url": "https://api.github.com/users/tyler6204/orgs",
    "repos_url": "https://api.github.com/users/tyler6204/repos",
    "events_url": "https://api.github.com/users/tyler6204/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tyler6204/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "labels": [
    {
      "id": 10064298757,
      "node_id": "LA_kwDOQb6kR88AAAACV-EDBQ",
      "url": "https://api.github.com/repos/openclaw/openclaw/labels/app:%20web-ui",
      "name": "app: web-ui",
      "color": "6f42c1",
      "default": false,
      "description": "App: web-ui"
    },
    {
      "id": 10064298857,
      "node_id": "LA_kwDOQb6kR88AAAACV-EDaQ",
      "url": "https://api.github.com/repos/openclaw/openclaw/labels/gateway",
      "name": "gateway",
      "color": "d4c5f9",
      "default": false,
      "description": "Gateway runtime"
    },
    {
      "id": 10069934037,
      "node_id": "LA_kwDOQb6kR88AAAACWDb_1Q",
      "url": "https://api.github.com/repos/openclaw/openclaw/labels/scripts",
      "name": "scripts",
      "color": "5319e7",
      "default": false,
      "description": "Repository scripts"
    },
    {
      "id": 10069934305,
      "node_id": "LA_kwDOQb6kR88AAAACWDcA4Q",
      "url": "https://api.github.com/repos/openclaw/openclaw/labels/commands",
      "name": "commands",
      "color": "0052cc",
      "default": false,
      "description": "Command implementations"
    },
    {
      "id": 10069976942,
      "node_id": "LA_kwDOQb6kR88AAAACWDenbg",
      "url": "https://api.github.com/repos/openclaw/openclaw/labels/agents",
      "name": "agents",
      "color": "5319e7",
      "default": false,
      "description": "Agent runtime and tooling"
    },
    {
      "id": 10118530218,
      "node_id": "LA_kwDOQb6kR88AAAACWxyEqg",
      "url": "https://api.github.com/repos/openclaw/openclaw/labels/maintainer",
      "name": "maintainer",
      "color": "FFD700",
      "default": false,
      "description": "Maintainer-authored PR"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "tyler6204",
    "id": 64381258,
    "node_id": "MDQ6VXNlcjY0MzgxMjU4",
    "avatar_url": "https://avatars.githubusercontent.com/u/64381258?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tyler6204",
    "html_url": "https://github.com/tyler6204",
    "followers_url": "https://api.github.com/users/tyler6204/followers",
    "following_url": "https://api.github.com/users/tyler6204/following{/other_user}",
    "gists_url": "https://api.github.com/users/tyler6204/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tyler6204/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tyler6204/subscriptions",
    "organizations_url": "https://api.github.com/users/tyler6204/orgs",
    "repos_url": "https://api.github.com/users/tyler6204/repos",
    "events_url": "https://api.github.com/users/tyler6204/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tyler6204/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "tyler6204",
      "id": 64381258,
      "node_id": "MDQ6VXNlcjY0MzgxMjU4",
      "avatar_url": "https://avatars.githubusercontent.com/u/64381258?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tyler6204",
      "html_url": "https://github.com/tyler6204",
      "followers_url": "https://api.github.com/users/tyler6204/followers",
      "following_url": "https://api.github.com/users/tyler6204/following{/other_user}",
      "gists_url": "https://api.github.com/users/tyler6204/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tyler6204/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tyler6204/subscriptions",
      "organizations_url": "https://api.github.com/users/tyler6204/orgs",
      "repos_url": "https://api.github.com/users/tyler6204/repos",
      "events_url": "https://api.github.com/users/tyler6204/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tyler6204/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 1,
  "created_at": "2026-02-08T00:23:33Z",
  "updated_at": "2026-02-08T03:48:02Z",
  "closed_at": "2026-02-08T03:48:02Z",
  "author_association": "MEMBER",
  "type": null,
  "active_lock_reason": null,
  "draft": false,
  "pull_request": {
    "url": "https://api.github.com/repos/openclaw/openclaw/pulls/11551",
    "html_url": "https://github.com/openclaw/openclaw/pull/11551",
    "diff_url": "https://github.com/openclaw/openclaw/pull/11551.diff",
    "patch_url": "https://github.com/openclaw/openclaw/pull/11551.patch",
    "merged_at": null
  },
  "body": "## Summary\n\nThis PR fixes four linked regressions in subagent overflow-compaction flows:\n\n1. Main-session announcements could fire too early and report stale/empty output.\n2. Session status metrics could show incorrect token totals and `Compactions: 0` even when compaction happened.\n3. Very large waits could trigger `TimeoutOverflowWarning` and distort timer behavior.\n4. Context usage could display impossible values (for example `2.4m/200k`) after heavy cached runs.\n\n## What Changed\n\n### 1) Defer stale/no-output announcements until the child run settles\n\n- `src/agents/subagent-announce.ts`\n  - Waits for embedded child run settlement when still active.\n  - Defers (`didAnnounce=false`) instead of announcing stale `(no output)` while run is still active.\n  - Retries reading the latest assistant reply for a bounded window before announcing.\n\n- `src/agents/subagent-registry.ts`\n  - Uses a larger settle timeout (`120_000ms`) in registry-triggered announce paths so compaction-retry runs can finish before announce.\n\n### 2) Persist accurate usage + compaction metrics across retries/compaction\n\n- `src/agents/pi-embedded-subscribe.ts`\n- `src/agents/pi-embedded-subscribe.handlers.messages.ts`\n- `src/agents/pi-embedded-subscribe.handlers.lifecycle.ts`\n- `src/agents/pi-embedded-subscribe.handlers.types.ts`\n  - Tracks assistant usage cumulatively per attempt.\n  - Tracks compaction starts in the embedded lifecycle.\n\n- `src/agents/pi-embedded-runner/run/attempt.ts`\n- `src/agents/pi-embedded-runner/run/types.ts`\n- `src/agents/pi-embedded-runner/run.ts`\n- `src/agents/pi-embedded-runner/types.ts`\n  - Returns attempt usage + compaction counts from attempts.\n  - Aggregates usage/compaction across overflow retries and direct compaction retries.\n  - Emits aggregated values in final agent meta.\n\n- `src/commands/agent/session-store.ts`\n  - Persists `compactionCount` increments from `agentMeta.compactionCount`.\n  - Uses aggregated usage totals from run meta so session cards reflect real totals.\n\n### 3) Clamp long timers to safe bounds\n\n- `src/agents/timeout.ts`\n- `src/gateway/call.ts`\n- `src/gateway/server-methods/agent-job.ts`\n  - Clamps timeout values to timer-safe max ranges to avoid 32-bit overflow warnings.\n\n### 4) Cap session `totalTokens` to model context window for status/memory semantics\n\n- `src/agents/usage.ts`\n  - Added `deriveSessionTotalTokens(...)` helper:\n    - Prefers prompt-sized token math (`input + cacheRead + cacheWrite`) when present.\n    - Falls back to provider `total`/`input` when needed.\n    - Caps persisted totals to `contextTokens` to avoid impossible context percentages.\n\n- `src/commands/agent/session-store.ts`\n- `src/auto-reply/reply/session-usage.ts`\n- `src/cron/isolated-agent/run.ts`\n  - Replaced ad-hoc prompt-token assignment with `deriveSessionTotalTokens(...)` so all session-update paths use the same bounded token derivation.\n\n## Tests\n\n### Updated\n\n- `src/agents/usage.test.ts`\n  - Adds regression coverage for large cache-read totals being capped by context window.\n  - Adds a normal-path assertion for prompt-token derivation within context bounds.\n\n- `src/agents/pi-embedded-runner/run.overflow-compaction.test.ts`\n  - Added missing usage helper mock for new aggregation path.\n  - Keeps overflow retry/compaction behavior coverage passing.\n\n- `src/agents/subagent-announce.format.test.ts`\n  - Covers deferred announce and retry-read behavior.\n\n- `src/agents/openclaw-tools.subagents.sessions-spawn-resolves-main-announce-target-from.test.ts`\n- `src/agents/openclaw-tools.subagents.sessions-spawn-announces-agent-wait-lifecycle-events.test.ts`\n  - Added `chat.history` mock reply so lifecycle cleanup/announce tests follow the new settle/retry path deterministically.\n\n## Validation\n\n- `pnpm exec vitest run src/agents/pi-embedded-runner/run.overflow-compaction.test.ts src/agents/openclaw-tools.subagents.sessions-spawn-resolves-main-announce-target-from.test.ts src/agents/openclaw-tools.subagents.sessions-spawn-announces-agent-wait-lifecycle-events.test.ts src/agents/subagent-announce.format.test.ts`\n- `pnpm exec vitest run src/agents/usage.test.ts src/auto-reply/status.test.ts`\n\n## Result\n\n- Subagent announcements no longer race ahead of compaction-retry completion.\n- Session cards now report realistic token totals and non-zero compaction counts when compaction occurred.\n- Context usage no longer reports impossible multi-million token values against 200k context windows.\n\n<!-- greptile_comment -->\n\n<h2>Greptile Overview</h2>\n\n<h3>Greptile Summary</h3>\n\nThis PR tightens up subagent overflow/compaction behavior across the embedded runner, announcement flow, and session usage persistence.\n\nKey changes:\n- **Announcements:** `runSubagentAnnounceFlow` now waits for an active embedded child run to settle before announcing, retries reading the latest assistant reply for a bounded window, and defers announcing (and deletion) when the child is still active to avoid stale “(no output)” announcements (`src/agents/subagent-announce.ts`). The registry uses a larger announce timeout and preserves delete-mode runs for retry when announces are deferred (`src/agents/subagent-registry.ts`).\n- **Usage/compaction metrics:** embedded attempts now surface per-attempt usage totals and compaction counts via the subscription, and the runner aggregates these across retries/compactions to emit accurate final `agentMeta` (`src/agents/pi-embedded-subscribe.ts`, `src/agents/pi-embedded-runner/run.ts`, `src/commands/agent/session-store.ts`).\n- **Timeout clamping:** very large timeouts are clamped to timer-safe maximums to avoid overflow warnings and distorted timer behavior (`src/agents/timeout.ts`, `src/gateway/call.ts`, `src/gateway/server-methods/agent-job.ts`).\n- **Session total tokens:** introduces `deriveSessionTotalTokens` to consistently derive and cap session `totalTokens` to the model context window where known, preventing impossible “millions/200k” status display (`src/agents/usage.ts`) and adopts it in all session update paths.\n\nThe changes fit into existing patterns by keeping normalization logic in `src/agents/usage.ts`, surfacing attempt-level state via the embedded subscribe context, and centralizing session persistence in `session-store`/`session-usage` update paths.\n\n<h3>Confidence Score: 5/5</h3>\n\n- This PR is safe to merge with minimal risk.\n- Review of the diff did not surface any definite correctness issues introduced by the changes. The modifications are cohesive (announce settling, usage/compaction aggregation, and timeout/token clamping) and are covered by targeted unit/regression tests that exercise the new behavior paths.\n- No files require special attention\n\n<!-- greptile_other_comments_section -->\n\n<!-- /greptile_comment -->",
  "closed_by": {
    "login": "tyler6204",
    "id": 64381258,
    "node_id": "MDQ6VXNlcjY0MzgxMjU4",
    "avatar_url": "https://avatars.githubusercontent.com/u/64381258?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tyler6204",
    "html_url": "https://github.com/tyler6204",
    "followers_url": "https://api.github.com/users/tyler6204/followers",
    "following_url": "https://api.github.com/users/tyler6204/following{/other_user}",
    "gists_url": "https://api.github.com/users/tyler6204/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tyler6204/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tyler6204/subscriptions",
    "organizations_url": "https://api.github.com/users/tyler6204/orgs",
    "repos_url": "https://api.github.com/users/tyler6204/repos",
    "events_url": "https://api.github.com/users/tyler6204/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tyler6204/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/openclaw/openclaw/issues/11551/reactions",
    "total_count": 1,
    "+1": 1,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/openclaw/openclaw/issues/11551/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
