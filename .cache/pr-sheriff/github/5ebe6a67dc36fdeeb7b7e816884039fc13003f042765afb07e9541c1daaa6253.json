{
  "url": "https://api.github.com/repos/openclaw/openclaw/issues/10580",
  "repository_url": "https://api.github.com/repos/openclaw/openclaw",
  "labels_url": "https://api.github.com/repos/openclaw/openclaw/issues/10580/labels{/name}",
  "comments_url": "https://api.github.com/repos/openclaw/openclaw/issues/10580/comments",
  "events_url": "https://api.github.com/repos/openclaw/openclaw/issues/10580/events",
  "html_url": "https://github.com/openclaw/openclaw/pull/10580",
  "id": 3907825429,
  "node_id": "PR_kwDOQb6kR87CDWLc",
  "number": 10580,
  "title": "fix: clamp cron timer delay to 60s as drift guard",
  "user": {
    "login": "zhiyuanw101",
    "id": 31650641,
    "node_id": "MDQ6VXNlcjMxNjUwNjQx",
    "avatar_url": "https://avatars.githubusercontent.com/u/31650641?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/zhiyuanw101",
    "html_url": "https://github.com/zhiyuanw101",
    "followers_url": "https://api.github.com/users/zhiyuanw101/followers",
    "following_url": "https://api.github.com/users/zhiyuanw101/following{/other_user}",
    "gists_url": "https://api.github.com/users/zhiyuanw101/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/zhiyuanw101/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/zhiyuanw101/subscriptions",
    "organizations_url": "https://api.github.com/users/zhiyuanw101/orgs",
    "repos_url": "https://api.github.com/users/zhiyuanw101/repos",
    "events_url": "https://api.github.com/users/zhiyuanw101/events{/privacy}",
    "received_events_url": "https://api.github.com/users/zhiyuanw101/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "labels": [],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [],
  "milestone": null,
  "comments": 1,
  "created_at": "2026-02-06T17:51:56Z",
  "updated_at": "2026-02-08T03:47:14Z",
  "closed_at": "2026-02-08T03:47:14Z",
  "author_association": "NONE",
  "type": null,
  "active_lock_reason": null,
  "draft": false,
  "pull_request": {
    "url": "https://api.github.com/repos/openclaw/openclaw/pulls/10580",
    "html_url": "https://github.com/openclaw/openclaw/pull/10580",
    "diff_url": "https://github.com/openclaw/openclaw/pull/10580.diff",
    "patch_url": "https://github.com/openclaw/openclaw/pull/10580.patch",
    "merged_at": null
  },
  "body": "## Problem\n\nFixes #10564\n\nThe cron scheduler relies solely on `setTimeout` to trigger job execution. If the timer is silently lost — due to macOS sleep/wake, GC pause, process throttling, or any other runtime disruption — no recovery mechanism exists. The missed job slot is never executed until an external API call (e.g. `cron list`) happens to call `ensureLoaded` → `recomputeNextRuns` → `armTimer`.\n\n**Observed behavior:** A cron job scheduled for 7:00 AM PST (`0 7-19 * * 1-5`) did not fire until manually triggered 2+ hours later. Gateway logs showed the timer was correctly armed after job creation but never fired, likely due to macOS power management suspending the Node.js event loop during sleep.\n\n## Solution\n\nClamp the maximum `setTimeout` delay in `armTimer()` to **60 seconds** via `DRIFT_GUARD_MAX_DELAY_MS`. This means:\n\n- When a job is due in <60s: timer fires at the exact due time (no change)\n- When a job is due in >60s: timer fires every 60s, `onTimer()` finds no overdue jobs, does nothing, and re-arms\n- When a timer was lost (sleep/wake): the next 60s wake catches the overdue job within at most 1 minute\n\nThis is simpler and more robust than a separate `setInterval` drift guard:\n- No second timer to manage or leak\n- No interaction issues with fake timers in tests  \n- Same `setTimeout` + re-arm pattern already used by the scheduler\n- Minimal overhead (~1 timer wake/minute when idle)\n\n## Changes\n\n- **`src/cron/service/timer.ts`**: Add `DRIFT_GUARD_MAX_DELAY_MS = 60_000` constant, clamp delay in `armTimer()`\n- **`src/cron/service.drift-guard-catches-overdue-jobs.test.ts`**: Two new tests validating the drift guard behavior\n\n## Test Results\n\nAll 60 tests pass (58 existing + 2 new):\n```\n Test Files  14 passed (14)\n      Tests  60 passed (60)\n```\n\n<!-- greptile_comment -->\n\n<h2>Greptile Overview</h2>\n\n<h3>Greptile Summary</h3>\n\n- Adds a drift-guard to the cron scheduler by clamping `setTimeout` delays in `armTimer()` to a maximum of 60s, so overdue jobs can be detected even if the original timer was lost (sleep/GC/throttling).\n- Introduces `DRIFT_GUARD_MAX_DELAY_MS` and updates timer arming to use the minimum of computed delay, Node’s max timeout, and the drift-guard cap.\n- Adds two Vitest tests that simulate timer loss and validate that the scheduler re-arms and eventually runs overdue jobs, while not executing far-future jobs early.\n\n<h3>Confidence Score: 4/5</h3>\n\n- This PR is generally safe to merge; the core timer change is small and the added tests cover the intended drift-guard behavior.\n- The change is localized to clamping the timer delay and is backed by new tests that exercise overdue-job recovery and far-future behavior. The main outstanding concern is test resource cleanup patterns that can leak temp dirs/timers on assertion failure, which can cause flakiness in CI or local runs.\n- src/cron/service.drift-guard-catches-overdue-jobs.test.ts\n\n<!-- greptile_other_comments_section -->\n\n<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>\n\n<!-- /greptile_comment -->",
  "closed_by": {
    "login": "tyler6204",
    "id": 64381258,
    "node_id": "MDQ6VXNlcjY0MzgxMjU4",
    "avatar_url": "https://avatars.githubusercontent.com/u/64381258?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tyler6204",
    "html_url": "https://github.com/tyler6204",
    "followers_url": "https://api.github.com/users/tyler6204/followers",
    "following_url": "https://api.github.com/users/tyler6204/following{/other_user}",
    "gists_url": "https://api.github.com/users/tyler6204/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tyler6204/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tyler6204/subscriptions",
    "organizations_url": "https://api.github.com/users/tyler6204/orgs",
    "repos_url": "https://api.github.com/users/tyler6204/repos",
    "events_url": "https://api.github.com/users/tyler6204/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tyler6204/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/openclaw/openclaw/issues/10580/reactions",
    "total_count": 1,
    "+1": 1,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/openclaw/openclaw/issues/10580/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
