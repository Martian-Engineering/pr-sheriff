{
  "url": "https://api.github.com/repos/openclaw/openclaw/issues/4465",
  "repository_url": "https://api.github.com/repos/openclaw/openclaw",
  "labels_url": "https://api.github.com/repos/openclaw/openclaw/issues/4465/labels{/name}",
  "comments_url": "https://api.github.com/repos/openclaw/openclaw/issues/4465/comments",
  "events_url": "https://api.github.com/repos/openclaw/openclaw/issues/4465/events",
  "html_url": "https://github.com/openclaw/openclaw/pull/4465",
  "id": 3874484267,
  "node_id": "PR_kwDOQb6kR87AVLg_",
  "number": 4465,
  "title": "fix: Make cron systemEvents trigger autonomous agent action",
  "user": {
    "login": "spiceoogway",
    "id": 105812383,
    "node_id": "U_kgDOBk6Rnw",
    "avatar_url": "https://avatars.githubusercontent.com/u/105812383?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/spiceoogway",
    "html_url": "https://github.com/spiceoogway",
    "followers_url": "https://api.github.com/users/spiceoogway/followers",
    "following_url": "https://api.github.com/users/spiceoogway/following{/other_user}",
    "gists_url": "https://api.github.com/users/spiceoogway/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/spiceoogway/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/spiceoogway/subscriptions",
    "organizations_url": "https://api.github.com/users/spiceoogway/orgs",
    "repos_url": "https://api.github.com/users/spiceoogway/repos",
    "events_url": "https://api.github.com/users/spiceoogway/events{/privacy}",
    "received_events_url": "https://api.github.com/users/spiceoogway/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "labels": [
    {
      "id": 9706244975,
      "node_id": "LA_kwDOQb6kR88AAAACQomLbw",
      "url": "https://api.github.com/repos/openclaw/openclaw/labels/docs",
      "name": "docs",
      "color": "0075ca",
      "default": false,
      "description": "Improvements or additions to documentation"
    },
    {
      "id": 10064298528,
      "node_id": "LA_kwDOQb6kR88AAAACV-ECIA",
      "url": "https://api.github.com/repos/openclaw/openclaw/labels/channel:%20whatsapp-web",
      "name": "channel: whatsapp-web",
      "color": "1d76db",
      "default": false,
      "description": "Channel integration: whatsapp-web"
    },
    {
      "id": 10069934305,
      "node_id": "LA_kwDOQb6kR88AAAACWDcA4Q",
      "url": "https://api.github.com/repos/openclaw/openclaw/labels/commands",
      "name": "commands",
      "color": "0052cc",
      "default": false,
      "description": "Command implementations"
    },
    {
      "id": 10069976942,
      "node_id": "LA_kwDOQb6kR88AAAACWDenbg",
      "url": "https://api.github.com/repos/openclaw/openclaw/labels/agents",
      "name": "agents",
      "color": "5319e7",
      "default": false,
      "description": "Agent runtime and tooling"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [],
  "milestone": null,
  "comments": 2,
  "created_at": "2026-01-30T07:48:36Z",
  "updated_at": "2026-02-01T16:06:33Z",
  "closed_at": "2026-02-01T13:25:47Z",
  "author_association": "CONTRIBUTOR",
  "type": null,
  "active_lock_reason": null,
  "draft": false,
  "pull_request": {
    "url": "https://api.github.com/repos/openclaw/openclaw/pulls/4465",
    "html_url": "https://github.com/openclaw/openclaw/pull/4465",
    "diff_url": "https://github.com/openclaw/openclaw/pull/4465.diff",
    "patch_url": "https://github.com/openclaw/openclaw/pull/4465.patch",
    "merged_at": null
  },
  "body": "Fixes #4107\n\n## Problem\nCron jobs with `systemEvent` payloads enqueue events as passive text. The agent sees the events but doesn't autonomously process them, even when `HEARTBEAT.md` contains explicit instructions for handling specific event types.\n\n**Expected:** Agent should execute complex tasks (spawn subagents, perform searches, etc.) when receiving systemEvents  \n**Actual:** Agent sees systemEvent, replies `HEARTBEAT_OK`, takes no action\n\n## Root Cause\n- systemEvents are injected as passive `System: [timestamp] text` messages in conversation history\n- Standard heartbeat prompt is passive: \"Read HEARTBEAT.md... If nothing needs attention, reply HEARTBEAT_OK\"\n- No explicit instruction to **process and act** on systemEvents\n- Exec completion events already had a directive prompt, but generic systemEvents from cron didn't\n\n## Solution\nAdded directive prompt for generic systemEvents, following the existing pattern for exec completion events:\n\n1. **New constant `SYSTEM_EVENT_PROMPT`**: Explicitly instructs agent to:\n   - Check `HEARTBEAT.md` for event-specific handling instructions\n   - Execute required actions (spawn subagent, perform task, etc.)\n   - Only reply `HEARTBEAT_OK` if no action is needed\n\n2. **Modified prompt selection logic**: \n   - Detect generic (non-exec) systemEvents in queue\n   - Use directive prompt when generic events are present\n   - Falls back to standard heartbeat prompt when no events\n\n3. **Updated Provider context**: Sets `Provider: \"system-event\"` for proper tracking\n\n## Changes\n- `src/infra/heartbeat-runner.ts`:\n  - Added `SYSTEM_EVENT_PROMPT` constant (lines 100-105)\n  - Modified prompt selection to detect generic systemEvents (lines 510-523)\n  - Updated `Provider` field for system-event context\n\n## Testing\n- ✅ TypeScript compilation successful\n- ✅ Follows existing `exec-event` precedent\n- ✅ Backward compatible (only affects sessions with pending systemEvents)\n\n## Follow-up Tasks\n- [ ] Add integration test for cron → subagent spawn workflow\n- [ ] Update user documentation on systemEvent best practices\n- [ ] Consider extending pattern to other event types if needed",
  "closed_by": {
    "login": "clawdinator[bot]",
    "id": 253378751,
    "node_id": "BOT_kgDODxpAvw",
    "avatar_url": "https://avatars.githubusercontent.com/in/2607181?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/clawdinator%5Bbot%5D",
    "html_url": "https://github.com/apps/clawdinator",
    "followers_url": "https://api.github.com/users/clawdinator%5Bbot%5D/followers",
    "following_url": "https://api.github.com/users/clawdinator%5Bbot%5D/following{/other_user}",
    "gists_url": "https://api.github.com/users/clawdinator%5Bbot%5D/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/clawdinator%5Bbot%5D/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/clawdinator%5Bbot%5D/subscriptions",
    "organizations_url": "https://api.github.com/users/clawdinator%5Bbot%5D/orgs",
    "repos_url": "https://api.github.com/users/clawdinator%5Bbot%5D/repos",
    "events_url": "https://api.github.com/users/clawdinator%5Bbot%5D/events{/privacy}",
    "received_events_url": "https://api.github.com/users/clawdinator%5Bbot%5D/received_events",
    "type": "Bot",
    "user_view_type": "public",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/openclaw/openclaw/issues/4465/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/openclaw/openclaw/issues/4465/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
