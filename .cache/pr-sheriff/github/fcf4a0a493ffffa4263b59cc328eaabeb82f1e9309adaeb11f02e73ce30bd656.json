{
  "url": "https://api.github.com/repos/openclaw/openclaw/issues/10472",
  "repository_url": "https://api.github.com/repos/openclaw/openclaw",
  "labels_url": "https://api.github.com/repos/openclaw/openclaw/issues/10472/labels{/name}",
  "comments_url": "https://api.github.com/repos/openclaw/openclaw/issues/10472/comments",
  "events_url": "https://api.github.com/repos/openclaw/openclaw/issues/10472/events",
  "html_url": "https://github.com/openclaw/openclaw/issues/10472",
  "id": 3907173944,
  "node_id": "I_kwDOQb6kR87o4r44",
  "number": 10472,
  "title": "Cron jobs can silently skip scheduled runs after rapid gateway restarts",
  "user": {
    "login": "ZakWinnick",
    "id": 23143538,
    "node_id": "MDQ6VXNlcjIzMTQzNTM4",
    "avatar_url": "https://avatars.githubusercontent.com/u/23143538?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ZakWinnick",
    "html_url": "https://github.com/ZakWinnick",
    "followers_url": "https://api.github.com/users/ZakWinnick/followers",
    "following_url": "https://api.github.com/users/ZakWinnick/following{/other_user}",
    "gists_url": "https://api.github.com/users/ZakWinnick/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ZakWinnick/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ZakWinnick/subscriptions",
    "organizations_url": "https://api.github.com/users/ZakWinnick/orgs",
    "repos_url": "https://api.github.com/users/ZakWinnick/repos",
    "events_url": "https://api.github.com/users/ZakWinnick/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ZakWinnick/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "labels": [],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [],
  "milestone": null,
  "comments": 1,
  "created_at": "2026-02-06T15:01:28Z",
  "updated_at": "2026-02-07T02:07:10Z",
  "closed_at": "2026-02-07T02:07:10Z",
  "author_association": "NONE",
  "type": null,
  "active_lock_reason": null,
  "sub_issues_summary": {
    "total": 0,
    "completed": 0,
    "percent_completed": 0
  },
  "issue_dependencies_summary": {
    "blocked_by": 0,
    "total_blocked_by": 0,
    "blocking": 0,
    "total_blocking": 0
  },
  "body": "## Bug Description\n\nCron jobs can silently miss their scheduled fire time after multiple rapid gateway restarts (SIGUSR1 hot-reloads and/or SIGTERM cold restarts). The cron scheduler appears to miscalculate `nextRunAtMs`, jumping past the current day's scheduled window to the next valid time.\n\n## Steps to Reproduce\n\n1. Have a cron job scheduled (e.g., `\"30 6 * * 1-5\"` — 6:30 AM PT weekdays)\n2. Trigger multiple rapid SIGUSR1 hot-reloads in the hours before the cron is due (in our case, ~15 restarts between 10 PM and midnight, caused by sub-agents using `gateway config.patch`)\n3. Include at least one SIGTERM → full restart cycle in the sequence\n4. Wait for the cron's scheduled time\n\n## Expected Behavior\n\nThe cron job fires at its scheduled time (6:30 AM PT).\n\n## Actual Behavior\n\n- The cron job does **not** fire\n- `nextRunAtMs` is already set to the **next valid occurrence** (Monday, skipping Friday entirely), despite the gateway being up and stable for 7+ hours before the scheduled time\n- No errors in logs — the job is silently skipped\n- `cron runs` returns empty entries (no run history at all for the job)\n- Manually triggering with `cron run` returns `{\"ran\": false, \"reason\": \"not-due\"}`\n\n## Environment\n\n- **OpenClaw version**: 2026.2.3-1 (d84eb46)\n- **OS**: macOS (Darwin 25.2.0 arm64)\n- **Node**: v25.5.0\n\n## Timeline (from gateway.log, all UTC)\n\n```\n06:30:48 — SIGUSR1 config change reload (meta.lastTouchedAt, perplexity config)\n06:30:50 — SIGUSR1 second reload\n06:31:43 — SIGTERM full shutdown\n07:17:06 — Gateway back up (new PID, stable from here)\n           ... no restarts for 7+ hours ...\n14:30:00 — Cron should fire (6:30 AM PT) — nothing happens\n14:30:00 — nextRunAtMs already points to Monday 14:30 UTC\n```\n\nThe gateway was fully stable on PID 81528 from 07:35 UTC onward. The cron window at 14:30 UTC was 7 hours into a clean run — but the scheduler had already decided Friday's slot was passed.\n\n## Hypothesis\n\nDuring one of the rapid restart cycles, the cron scheduler reinitializes and evaluates `nextRunAtMs`. If the restart happens during or just after the evaluation window for a scheduled time, the scheduler may:\n\n1. See the current minute has \"already passed\" (even if it's the restart second, not the actual cron time)\n2. Calculate `nextRunAtMs` as the next valid cron match (skipping to Monday for a weekday-only schedule)\n3. Persist this incorrect `nextRunAtMs` and never re-evaluate it\n\nThis means a restart at 10:30 PM could cause the scheduler to skip a 6:30 AM job the next morning if the internal state isn't properly reconciled on startup.\n\n## Suggested Fix\n\nOn gateway startup, the cron scheduler should:\n1. Recalculate `nextRunAtMs` from scratch based on the current time\n2. Not trust persisted `nextRunAtMs` values that were set during a previous process lifetime\n3. Consider adding a \"catch-up\" mechanism — if a job's `nextRunAtMs` is in the past but within a grace window (e.g., 5 minutes), fire it immediately\n\n## Workaround\n\nShifted cron to an off-round-number time (6:31 instead of 6:30) and added a rule preventing sub-agents from using `gateway config.patch` to reduce restart frequency.",
  "closed_by": {
    "login": "tyler6204",
    "id": 64381258,
    "node_id": "MDQ6VXNlcjY0MzgxMjU4",
    "avatar_url": "https://avatars.githubusercontent.com/u/64381258?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tyler6204",
    "html_url": "https://github.com/tyler6204",
    "followers_url": "https://api.github.com/users/tyler6204/followers",
    "following_url": "https://api.github.com/users/tyler6204/following{/other_user}",
    "gists_url": "https://api.github.com/users/tyler6204/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tyler6204/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tyler6204/subscriptions",
    "organizations_url": "https://api.github.com/users/tyler6204/orgs",
    "repos_url": "https://api.github.com/users/tyler6204/repos",
    "events_url": "https://api.github.com/users/tyler6204/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tyler6204/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/openclaw/openclaw/issues/10472/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/openclaw/openclaw/issues/10472/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed",
  "pinned_comment": null
}
