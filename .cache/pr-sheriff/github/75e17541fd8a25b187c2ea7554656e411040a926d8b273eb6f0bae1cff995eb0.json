{
  "url": "https://api.github.com/repos/openclaw/openclaw/issues/11225",
  "repository_url": "https://api.github.com/repos/openclaw/openclaw",
  "labels_url": "https://api.github.com/repos/openclaw/openclaw/issues/11225/labels{/name}",
  "comments_url": "https://api.github.com/repos/openclaw/openclaw/issues/11225/comments",
  "events_url": "https://api.github.com/repos/openclaw/openclaw/issues/11225/events",
  "html_url": "https://github.com/openclaw/openclaw/pull/11225",
  "id": 3910562711,
  "node_id": "PR_kwDOQb6kR87CMLN9",
  "number": 11225,
  "title": "fix(cron): ensure timer is armed after job creation",
  "user": {
    "login": "git-tao",
    "id": 45883564,
    "node_id": "MDQ6VXNlcjQ1ODgzNTY0",
    "avatar_url": "https://avatars.githubusercontent.com/u/45883564?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/git-tao",
    "html_url": "https://github.com/git-tao",
    "followers_url": "https://api.github.com/users/git-tao/followers",
    "following_url": "https://api.github.com/users/git-tao/following{/other_user}",
    "gists_url": "https://api.github.com/users/git-tao/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/git-tao/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/git-tao/subscriptions",
    "organizations_url": "https://api.github.com/users/git-tao/orgs",
    "repos_url": "https://api.github.com/users/git-tao/repos",
    "events_url": "https://api.github.com/users/git-tao/events{/privacy}",
    "received_events_url": "https://api.github.com/users/git-tao/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "labels": [],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [],
  "milestone": null,
  "comments": 1,
  "created_at": "2026-02-07T15:34:40Z",
  "updated_at": "2026-02-08T03:47:26Z",
  "closed_at": "2026-02-08T03:47:26Z",
  "author_association": "NONE",
  "type": null,
  "active_lock_reason": null,
  "draft": false,
  "pull_request": {
    "url": "https://api.github.com/repos/openclaw/openclaw/pulls/11225",
    "html_url": "https://github.com/openclaw/openclaw/pull/11225",
    "diff_url": "https://github.com/openclaw/openclaw/pull/11225.diff",
    "patch_url": "https://github.com/openclaw/openclaw/pull/11225.patch",
    "merged_at": null
  },
  "body": "## Problem\n\nCron jobs created after gateway start may not execute because:\n1. `nextRunAtMs` might not be computed correctly for the new job\n2. `armTimer` might exit early without setting up a timer\n3. No logging made these failures invisible\n\nUsers report jobs appearing valid (`enabled: true`) but having `lastRun: null` indefinitely.\n\n## Solution\n\n1. **Defensive recomputation**: Call `recomputeNextRuns()` after adding a job to ensure all jobs have correct `nextRunAtMs` values\n\n2. **Debug logging in armTimer**: When timer is not armed, log why:\n   - Scheduler disabled\n   - No jobs with `nextRunAtMs` (with counts for debugging)\n\n3. **Info logging after job add**: Confirms:\n   - Job ID and name\n   - Computed `nextRunAtMs`\n   - Scheduler's next wake time\n   - Whether timer was successfully armed\n\n## Changes\n\n- `src/cron/service/ops.ts`: Added `recomputeNextRuns()` call and logging after job creation\n- `src/cron/service/timer.ts`: Added debug logging for early exits in `armTimer()`\n\n## Testing\n\nThese changes are additive (logging) and defensive (recompute). They don't change the core logic, just ensure:\n1. Job state is consistent after add\n2. Failures are visible in logs\n\n## Related\n\nFixes #11217\n\n<!-- greptile_comment -->\n\n<h2>Greptile Overview</h2>\n\n<h3>Greptile Summary</h3>\n\nChanges update the cron scheduler to be more robust when jobs are created after startup. After adding a job, the service now recomputes `nextRunAtMs` across all jobs, persists the updated store, and logs the newly added jobâ€™s computed next run plus whether a timer is armed. The timer arming logic also adds debug logs for early exit cases (scheduler disabled / no jobs with computed `nextRunAtMs`) and logs when a timer is successfully armed (including whether the delay was clamped).\n\n<h3>Confidence Score: 5/5</h3>\n\n- This PR is safe to merge with minimal risk.\n- Edits are localized to cron scheduling and are additive/defensive: recomputing next-run timestamps after job creation and adding debug/info logging around timer arming. No behavior changes were found that would break scheduling; logging and recompute use existing helpers.\n- No files require special attention\n\n<!-- greptile_other_comments_section -->\n\n<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>\n\n**Context used:**\n\n- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))\n- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))\n\n<!-- /greptile_comment -->",
  "closed_by": {
    "login": "tyler6204",
    "id": 64381258,
    "node_id": "MDQ6VXNlcjY0MzgxMjU4",
    "avatar_url": "https://avatars.githubusercontent.com/u/64381258?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tyler6204",
    "html_url": "https://github.com/tyler6204",
    "followers_url": "https://api.github.com/users/tyler6204/followers",
    "following_url": "https://api.github.com/users/tyler6204/following{/other_user}",
    "gists_url": "https://api.github.com/users/tyler6204/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tyler6204/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tyler6204/subscriptions",
    "organizations_url": "https://api.github.com/users/tyler6204/orgs",
    "repos_url": "https://api.github.com/users/tyler6204/repos",
    "events_url": "https://api.github.com/users/tyler6204/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tyler6204/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/openclaw/openclaw/issues/11225/reactions",
    "total_count": 1,
    "+1": 1,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/openclaw/openclaw/issues/11225/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
