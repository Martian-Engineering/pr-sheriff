{
  "url": "https://api.github.com/repos/openclaw/openclaw/issues/10776",
  "repository_url": "https://api.github.com/repos/openclaw/openclaw",
  "labels_url": "https://api.github.com/repos/openclaw/openclaw/issues/10776/labels{/name}",
  "comments_url": "https://api.github.com/repos/openclaw/openclaw/issues/10776/comments",
  "events_url": "https://api.github.com/repos/openclaw/openclaw/issues/10776/events",
  "html_url": "https://github.com/openclaw/openclaw/pull/10776",
  "id": 3908907241,
  "node_id": "PR_kwDOQb6kR87CG4M1",
  "number": 10776,
  "title": "fix: cron scheduler reliability, store hardening, and UX improvements",
  "user": {
    "login": "tyler6204",
    "id": 64381258,
    "node_id": "MDQ6VXNlcjY0MzgxMjU4",
    "avatar_url": "https://avatars.githubusercontent.com/u/64381258?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tyler6204",
    "html_url": "https://github.com/tyler6204",
    "followers_url": "https://api.github.com/users/tyler6204/followers",
    "following_url": "https://api.github.com/users/tyler6204/following{/other_user}",
    "gists_url": "https://api.github.com/users/tyler6204/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tyler6204/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tyler6204/subscriptions",
    "organizations_url": "https://api.github.com/users/tyler6204/orgs",
    "repos_url": "https://api.github.com/users/tyler6204/repos",
    "events_url": "https://api.github.com/users/tyler6204/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tyler6204/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "labels": [
    {
      "id": 9706244967,
      "node_id": "LA_kwDOQb6kR88AAAACQomLZw",
      "url": "https://api.github.com/repos/openclaw/openclaw/labels/bug",
      "name": "bug",
      "color": "d73a4a",
      "default": true,
      "description": "Something isn't working"
    },
    {
      "id": 9706244975,
      "node_id": "LA_kwDOQb6kR88AAAACQomLbw",
      "url": "https://api.github.com/repos/openclaw/openclaw/labels/docs",
      "name": "docs",
      "color": "0075ca",
      "default": false,
      "description": "Improvements or additions to documentation"
    },
    {
      "id": 10064298719,
      "node_id": "LA_kwDOQb6kR88AAAACV-EC3w",
      "url": "https://api.github.com/repos/openclaw/openclaw/labels/app:%20macos",
      "name": "app: macos",
      "color": "6f42c1",
      "default": false,
      "description": "App: macos"
    },
    {
      "id": 10064298757,
      "node_id": "LA_kwDOQb6kR88AAAACV-EDBQ",
      "url": "https://api.github.com/repos/openclaw/openclaw/labels/app:%20web-ui",
      "name": "app: web-ui",
      "color": "6f42c1",
      "default": false,
      "description": "App: web-ui"
    },
    {
      "id": 10064298857,
      "node_id": "LA_kwDOQb6kR88AAAACV-EDaQ",
      "url": "https://api.github.com/repos/openclaw/openclaw/labels/gateway",
      "name": "gateway",
      "color": "d4c5f9",
      "default": false,
      "description": "Gateway runtime"
    },
    {
      "id": 10068150099,
      "node_id": "LA_kwDOQb6kR88AAAACWBvHUw",
      "url": "https://api.github.com/repos/openclaw/openclaw/labels/cli",
      "name": "cli",
      "color": "0052cc",
      "default": false,
      "description": "CLI command changes"
    },
    {
      "id": 10069934037,
      "node_id": "LA_kwDOQb6kR88AAAACWDb_1Q",
      "url": "https://api.github.com/repos/openclaw/openclaw/labels/scripts",
      "name": "scripts",
      "color": "5319e7",
      "default": false,
      "description": "Repository scripts"
    },
    {
      "id": 10069976942,
      "node_id": "LA_kwDOQb6kR88AAAACWDenbg",
      "url": "https://api.github.com/repos/openclaw/openclaw/labels/agents",
      "name": "agents",
      "color": "5319e7",
      "default": false,
      "description": "Agent runtime and tooling"
    },
    {
      "id": 10118530218,
      "node_id": "LA_kwDOQb6kR88AAAACWxyEqg",
      "url": "https://api.github.com/repos/openclaw/openclaw/labels/maintainer",
      "name": "maintainer",
      "color": "FFD700",
      "default": false,
      "description": "Maintainer-authored PR"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "tyler6204",
    "id": 64381258,
    "node_id": "MDQ6VXNlcjY0MzgxMjU4",
    "avatar_url": "https://avatars.githubusercontent.com/u/64381258?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tyler6204",
    "html_url": "https://github.com/tyler6204",
    "followers_url": "https://api.github.com/users/tyler6204/followers",
    "following_url": "https://api.github.com/users/tyler6204/following{/other_user}",
    "gists_url": "https://api.github.com/users/tyler6204/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tyler6204/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tyler6204/subscriptions",
    "organizations_url": "https://api.github.com/users/tyler6204/orgs",
    "repos_url": "https://api.github.com/users/tyler6204/repos",
    "events_url": "https://api.github.com/users/tyler6204/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tyler6204/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "tyler6204",
      "id": 64381258,
      "node_id": "MDQ6VXNlcjY0MzgxMjU4",
      "avatar_url": "https://avatars.githubusercontent.com/u/64381258?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tyler6204",
      "html_url": "https://github.com/tyler6204",
      "followers_url": "https://api.github.com/users/tyler6204/followers",
      "following_url": "https://api.github.com/users/tyler6204/following{/other_user}",
      "gists_url": "https://api.github.com/users/tyler6204/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tyler6204/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tyler6204/subscriptions",
      "organizations_url": "https://api.github.com/users/tyler6204/orgs",
      "repos_url": "https://api.github.com/users/tyler6204/repos",
      "events_url": "https://api.github.com/users/tyler6204/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tyler6204/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 1,
  "created_at": "2026-02-07T00:11:56Z",
  "updated_at": "2026-02-07T02:03:17Z",
  "closed_at": "2026-02-07T02:03:04Z",
  "author_association": "MEMBER",
  "type": null,
  "active_lock_reason": null,
  "draft": false,
  "pull_request": {
    "url": "https://api.github.com/repos/openclaw/openclaw/pulls/10776",
    "html_url": "https://github.com/openclaw/openclaw/pull/10776",
    "diff_url": "https://github.com/openclaw/openclaw/pull/10776.diff",
    "patch_url": "https://github.com/openclaw/openclaw/pull/10776.patch",
    "merged_at": "2026-02-07T02:03:04Z"
  },
  "body": "## Summary\nThis PR is a cron reliability and compatibility sweep. It fixes scheduler/run regressions, hardens cron payload migration + patch behavior, improves timer drift handling, and makes cron runs easier to inspect by preserving per-run session links from the cron dashboard.\n\nIt also keeps the newer default of `wakeMode: \"now\"` for newly created cron jobs.\n\n## What changed\n\n### 1) Scheduler execution + wake correctness\n- Fixed due-job execution flow and timer behavior so recurring/cron jobs fire instead of only rescheduling.\n- Improved `wakeMode=now` behavior when the main lane is busy:\n  - retry `runHeartbeatOnce`\n  - fallback to `requestHeartbeatNow` instead of ending as skipped timeout.\n- Startup behavior clears stale `runningAtMs` markers before catch-up.\n- Restart catch-up path executes overdue jobs more reliably.\n\n### 2) Cron run semantics\n- `cron.run` defaults to force execution (instead of due-only behavior).\n- Added explicit due-only option:\n  - tool: `runMode: \"due\"`\n  - CLI: `--due`\n- Gateway method defaults updated to match force behavior.\n\n### 3) Store/migration hardening\n- `loadCronStore` throws on non-ENOENT read/parse failures (no silent empty-store fallback).\n- `ensureLoaded` migration path now:\n  - initializes missing `job.state`\n  - backfills `schedule.anchorMs` for legacy `every` jobs to keep a stable interval anchor\n  - migrates legacy top-level agentTurn fields (`model`, `thinking`, `timeoutSeconds`, `allowUnsafeExternalContent`, legacy delivery hints) into canonical payload/delivery\n  - strips legacy top-level fields after migration.\n\n### 4) Compatibility + schema fixes\n- Fixed `cron.update` persistence for `payload.allowUnsafeExternalContent`.\n- Added cron payload schema support for legacy compatibility fields used by older clients:\n  - `deliver`, `channel`, `to`, `bestEffortDeliver`\n- Added e2e coverage that verifies legacy payload patch fields map into canonical delivery config.\n\n### 5) Timer drift guard\n- Cron timer delay is now clamped to `60_000ms` (1 minute) to reduce drift and recover more quickly from pauses/time jumps.\n- Added regression test coverage for far-future schedules to ensure the clamp is applied.\n- Added regression coverage for legacy `every` jobs without `anchorMs` so minute-level recomputes do not starve interval jobs.\n\n### 6) Cron run history and session UX\n- Isolated cron runs now persist run-specific session keys in addition to the stable cron key.\n- `cron.runs` entries now include `sessionId`/`sessionKey` metadata.\n- Dashboard cron run history now shows an `Open run chat` link to `/chat?session=...` for each run.\n- Cron session entries now get a default label (`Cron: <job name|id>`) when missing.\n- Existing cron labels are preserved across subsequent runs.\n\n### 7) UI/UX defaults\n- Cron default `wakeMode` is `now` for new jobs across:\n  - normalization defaults\n  - CLI `cron add --wake` default\n  - dashboard cron form\n  - macOS cron editor.\n- Fixed dashboard relative-time display for near-future timestamps (`in <1m` vs misleading `just now`).\n\n## Behavior changes (intentional)\n- New cron jobs default to `wakeMode: \"now\"`.\n- Cron run history can now deep-link to specific run sessions.\n- Sessions view will show meaningful default labels for cron-created sessions.\n\n## Issues addressed\nThis addresses a large number of cron-related issues including but not limited to:\n- #9661 (race condition: recomputeNextRuns before runDueJobs)\n- #10138, #10269, #10573 (recurring jobs never fire)\n- #4210, #9452, #10373, #10445 (lock contention / cron status-list timeouts)\n- #9655, #10045, #10564 (stale nextWakeAtMs after restart)\n- #4586, #10025, #10086, #10594 (nextRunAtMs off-by-one / schedule recompute bugs)\n- #10011 (cron run returns not-due instead of forcing)\n- #3520, #6828, #10211, #10523, #10602 (delivery and isolated execution compatibility)\n- #3569, #9283, #10437 (API/CLI schema compatibility)\n- #10208, #9236, #10534 (store robustness and migration)\n- #6737 (dashboard next-wake relative-time bug)\n- #10057 (UI: Run vs Runs confusion)\n\n## Validation\n- `pnpm exec vitest run src/cron/service.issue-regressions.test.ts src/cron/run-log.test.ts src/cron/isolated-agent.uses-last-non-empty-agent-text-as.test.ts`\n- `pnpm exec vitest run --config vitest.e2e.config.ts src/gateway/server.cron.e2e.test.ts`\n- `pnpm --dir ui exec vitest run --config vitest.config.ts src/ui/views/cron.test.ts`\n\n<!-- greptile_comment -->\n\n<h2>Greptile Overview</h2>\n\n<h3>Greptile Summary</h3>\n\n- Updates cron execution behavior (scheduler wake/run semantics, timer drift clamp) and improves restart/catch-up reliability.\n- Hardens cron store loading/migrations and expands schema compatibility for legacy cron payload/delivery fields.\n- Enhances cron run history by recording per-run session keys/ids and exposing deep-links in the dashboard.\n- Adjusts defaults (notably `wakeMode: \"now\"`) across CLI, UI, and macOS editor, plus related UX tweaks.\n- Adds regression/e2e tests covering scheduler behavior, migration, delivery semantics, and UI rendering.\n\n<h3>Confidence Score: 3/5</h3>\n\n- This PR is moderately safe to merge but contains at least one behavior-changing delivery default that can cause unexpected outbound messages.\n- The changes are broad and touch scheduler execution, store migration, gateway schema, and UI; tests were added, but the delivery default (`delivery` object without `mode` => announce) is a concrete behavior change that can impact production jobs if such persisted data exists.\n- src/cron/delivery.ts (delivery default semantics); also re-check migration paths that may create/leave delivery objects without explicit mode.\n\n<!-- greptile_other_comments_section -->\n\n<!-- /greptile_comment -->",
  "closed_by": {
    "login": "tyler6204",
    "id": 64381258,
    "node_id": "MDQ6VXNlcjY0MzgxMjU4",
    "avatar_url": "https://avatars.githubusercontent.com/u/64381258?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tyler6204",
    "html_url": "https://github.com/tyler6204",
    "followers_url": "https://api.github.com/users/tyler6204/followers",
    "following_url": "https://api.github.com/users/tyler6204/following{/other_user}",
    "gists_url": "https://api.github.com/users/tyler6204/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tyler6204/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tyler6204/subscriptions",
    "organizations_url": "https://api.github.com/users/tyler6204/orgs",
    "repos_url": "https://api.github.com/users/tyler6204/repos",
    "events_url": "https://api.github.com/users/tyler6204/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tyler6204/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/openclaw/openclaw/issues/10776/reactions",
    "total_count": 3,
    "+1": 2,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 1,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/openclaw/openclaw/issues/10776/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
