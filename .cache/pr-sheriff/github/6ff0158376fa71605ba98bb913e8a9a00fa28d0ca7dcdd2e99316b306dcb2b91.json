{
  "url": "https://api.github.com/repos/openclaw/openclaw/issues/10934",
  "repository_url": "https://api.github.com/repos/openclaw/openclaw",
  "labels_url": "https://api.github.com/repos/openclaw/openclaw/issues/10934/labels{/name}",
  "comments_url": "https://api.github.com/repos/openclaw/openclaw/issues/10934/comments",
  "events_url": "https://api.github.com/repos/openclaw/openclaw/issues/10934/events",
  "html_url": "https://github.com/openclaw/openclaw/issues/10934",
  "id": 3909526373,
  "node_id": "I_kwDOQb6kR87pBqNl",
  "number": 10934,
  "title": "[Bug]: Cron jobs with 'every' schedule never execute - recomputeNextRuns() pushes times forward",
  "user": {
    "login": "andrew867",
    "id": 3827955,
    "node_id": "MDQ6VXNlcjM4Mjc5NTU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/3827955?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/andrew867",
    "html_url": "https://github.com/andrew867",
    "followers_url": "https://api.github.com/users/andrew867/followers",
    "following_url": "https://api.github.com/users/andrew867/following{/other_user}",
    "gists_url": "https://api.github.com/users/andrew867/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/andrew867/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/andrew867/subscriptions",
    "organizations_url": "https://api.github.com/users/andrew867/orgs",
    "repos_url": "https://api.github.com/users/andrew867/repos",
    "events_url": "https://api.github.com/users/andrew867/events{/privacy}",
    "received_events_url": "https://api.github.com/users/andrew867/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "labels": [],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [],
  "milestone": null,
  "comments": 4,
  "created_at": "2026-02-07T06:12:19Z",
  "updated_at": "2026-02-08T23:21:01Z",
  "closed_at": "2026-02-08T03:50:00Z",
  "author_association": "NONE",
  "type": null,
  "active_lock_reason": null,
  "sub_issues_summary": {
    "total": 0,
    "completed": 0,
    "percent_completed": 0
  },
  "issue_dependencies_summary": {
    "blocked_by": 0,
    "total_blocked_by": 0,
    "blocking": 0,
    "total_blocking": 0
  },
  "body": "## Summary\n\nCron jobs with `schedule.kind: \"every\"` never execute automatically because `recomputeNextRuns()` always recalculates `nextRunAtMs` based on current time, pushing all scheduled times forward before `runDueJobs()` can find any due jobs.\n\n## Steps to reproduce\n\n1. Create a cron job with `schedule: { kind: \"every\", everyMs: 1020000 }` (17 minutes)\n2. Wait for the scheduled time to arrive\n3. Observe that the job never executes automatically\n4. Check `nextWakeAtMs` - it keeps getting pushed forward by exactly the interval\n\n## Expected behavior\n\nCron jobs should execute automatically when `nextRunAtMs` is reached.\n\n## Actual behavior\n\nThe timer fires, but `recomputeNextRuns()` is called in `onTimer()` before `runDueJobs()`, which:\n\n1. Recalculates all `nextRunAtMs` based on current time\n2. For \"every\" schedules without `anchorMs`, uses current time as anchor (line 2932)\n3. Pushes all `nextRunAtMs` forward\n4. `runDueJobs()` finds no jobs due because times were just pushed forward\n5. `armTimer()` is called with the new (pushed forward) `nextWakeAtMs`\n\n**Root cause:** `recomputeNextRuns()` at line 3025 always recalculates `nextRunAtMs` for all jobs, even if they already have valid future times.\n\n## Environment\n\n- Clawdbot version: 2026.2.3-1\n- OS: Windows 10 (build 26200)\n- Install method: npm (global)\n\n## Proposed Fix\n\n`recomputeNextRuns()` should preserve existing `nextRunAtMs` if they are valid and in the future, only recalculating if:\n\n- The job does not have a `nextRunAtMs`\n- The `nextRunAtMs` is in the past\n- The job was just modified\n\n**Suggested fix in `src/cron/service/jobs.ts`:**\n\n```typescript\nfunction recomputeNextRuns(state) {\n  if (!state.store) return;\n  const now = state.deps.nowMs();\n  for (const job of state.store.jobs) {\n    if (!job.state) job.state = {};\n    if (!job.enabled) {\n      job.state.nextRunAtMs = void 0;\n      job.state.runningAtMs = void 0;\n      continue;\n    }\n    const runningAt = job.state.runningAtMs;\n    if (typeof runningAt === \"number\" && now - runningAt > STUCK_RUN_MS) {\n      state.deps.log.warn({\n        jobId: job.id,\n        runningAtMs: runningAt\n      }, \"cron: clearing stuck running marker\");\n      job.state.runningAtMs = void 0;\n    }\n    // PRESERVE existing nextRunAtMs if valid and in the future\n    const existingNext = job.state.nextRunAtMs;\n    if (typeof existingNext === \"number\" && existingNext > now) {\n      continue; // Keep existing valid future time\n    }\n    // Only recalculate if missing or in the past\n    job.state.nextRunAtMs = computeJobNextRunAtMs(job, now);\n  }\n}\n```\n\n## Workaround\n\nSet `anchorMs` for all \"every\" schedules to prevent recalculation from pushing times forward:\n\n```json\n{\n  \"schedule\": {\n    \"kind\": \"every\",\n    \"everyMs\": 1020000,\n    \"anchorMs\": 1770381715751\n  }\n}\n```\n\nThis ensures `computeNextRunAtMs()` uses a fixed anchor instead of current time. Use `createdAtMs` or `lastRunAtMs` as the anchor value.\n\n## Code References\n\n- Bug location: `dist/gateway-cli-D_8miTjF.js` line 3025 in `recomputeNextRuns()`\n- Related: `dist/gateway-cli-D_8miTjF.js` line 2932 in `computeNextRunAtMs()` (uses `nowMs` as anchor if `anchorMs` not set)\n- Timer flow: `onTimer()` → `ensureLoaded()` → `recomputeNextRuns()` → `runDueJobs()` → `armTimer()`\n\n## Logs\n\nThe timer fires (evidenced by `nextWakeAtMs` changing), but no jobs execute. No `onTimer`, `runDueJobs`, or `executeJob` entries in logs around scheduled times.\r\n",
  "closed_by": {
    "login": "tyler6204",
    "id": 64381258,
    "node_id": "MDQ6VXNlcjY0MzgxMjU4",
    "avatar_url": "https://avatars.githubusercontent.com/u/64381258?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tyler6204",
    "html_url": "https://github.com/tyler6204",
    "followers_url": "https://api.github.com/users/tyler6204/followers",
    "following_url": "https://api.github.com/users/tyler6204/following{/other_user}",
    "gists_url": "https://api.github.com/users/tyler6204/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tyler6204/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tyler6204/subscriptions",
    "organizations_url": "https://api.github.com/users/tyler6204/orgs",
    "repos_url": "https://api.github.com/users/tyler6204/repos",
    "events_url": "https://api.github.com/users/tyler6204/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tyler6204/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/openclaw/openclaw/issues/10934/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/openclaw/openclaw/issues/10934/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed",
  "pinned_comment": null
}
