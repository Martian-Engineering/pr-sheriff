{
  "url": "https://api.github.com/repos/openclaw/openclaw/issues/17296",
  "repository_url": "https://api.github.com/repos/openclaw/openclaw",
  "labels_url": "https://api.github.com/repos/openclaw/openclaw/issues/17296/labels{/name}",
  "comments_url": "https://api.github.com/repos/openclaw/openclaw/issues/17296/comments",
  "events_url": "https://api.github.com/repos/openclaw/openclaw/issues/17296/events",
  "html_url": "https://github.com/openclaw/openclaw/pull/17296",
  "id": 3944400604,
  "node_id": "PR_kwDOQb6kR87D7b8k",
  "number": 17296,
  "title": "fix: restore device token priority in device-auth mode",
  "user": {
    "login": "Limitless2023",
    "id": 127183162,
    "node_id": "U_kgDOB5SpOg",
    "avatar_url": "https://avatars.githubusercontent.com/u/127183162?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/Limitless2023",
    "html_url": "https://github.com/Limitless2023",
    "followers_url": "https://api.github.com/users/Limitless2023/followers",
    "following_url": "https://api.github.com/users/Limitless2023/following{/other_user}",
    "gists_url": "https://api.github.com/users/Limitless2023/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/Limitless2023/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/Limitless2023/subscriptions",
    "organizations_url": "https://api.github.com/users/Limitless2023/orgs",
    "repos_url": "https://api.github.com/users/Limitless2023/repos",
    "events_url": "https://api.github.com/users/Limitless2023/events{/privacy}",
    "received_events_url": "https://api.github.com/users/Limitless2023/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "labels": [
    {
      "id": 10064298117,
      "node_id": "LA_kwDOQb6kR88AAAACV-EAhQ",
      "url": "https://api.github.com/repos/openclaw/openclaw/labels/channel:%20discord",
      "name": "channel: discord",
      "color": "1d76db",
      "default": false,
      "description": "Channel integration: discord"
    },
    {
      "id": 10064298433,
      "node_id": "LA_kwDOQb6kR88AAAACV-EBwQ",
      "url": "https://api.github.com/repos/openclaw/openclaw/labels/channel:%20telegram",
      "name": "channel: telegram",
      "color": "1d76db",
      "default": false,
      "description": "Channel integration: telegram"
    },
    {
      "id": 10064298857,
      "node_id": "LA_kwDOQb6kR88AAAACV-EDaQ",
      "url": "https://api.github.com/repos/openclaw/openclaw/labels/gateway",
      "name": "gateway",
      "color": "d4c5f9",
      "default": false,
      "description": "Gateway runtime"
    },
    {
      "id": 10069934037,
      "node_id": "LA_kwDOQb6kR88AAAACWDb_1Q",
      "url": "https://api.github.com/repos/openclaw/openclaw/labels/scripts",
      "name": "scripts",
      "color": "5319e7",
      "default": false,
      "description": "Repository scripts"
    },
    {
      "id": 10069934305,
      "node_id": "LA_kwDOQb6kR88AAAACWDcA4Q",
      "url": "https://api.github.com/repos/openclaw/openclaw/labels/commands",
      "name": "commands",
      "color": "0052cc",
      "default": false,
      "description": "Command implementations"
    },
    {
      "id": 10069976942,
      "node_id": "LA_kwDOQb6kR88AAAACWDenbg",
      "url": "https://api.github.com/repos/openclaw/openclaw/labels/agents",
      "name": "agents",
      "color": "5319e7",
      "default": false,
      "description": "Agent runtime and tooling"
    },
    {
      "id": 10190106720,
      "node_id": "LA_kwDOQb6kR88AAAACX2CwYA",
      "url": "https://api.github.com/repos/openclaw/openclaw/labels/size:%20M",
      "name": "size: M",
      "color": "b76e79",
      "default": false,
      "description": null
    },
    {
      "id": 10209658940,
      "node_id": "LA_kwDOQb6kR88AAAACYIsIPA",
      "url": "https://api.github.com/repos/openclaw/openclaw/labels/dirty",
      "name": "dirty",
      "color": "000000",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [],
  "milestone": null,
  "comments": 1,
  "created_at": "2026-02-15T16:21:11Z",
  "updated_at": "2026-02-15T17:16:22Z",
  "closed_at": "2026-02-15T17:16:22Z",
  "author_association": "CONTRIBUTOR",
  "type": null,
  "active_lock_reason": null,
  "draft": false,
  "pull_request": {
    "url": "https://api.github.com/repos/openclaw/openclaw/pulls/17296",
    "html_url": "https://github.com/openclaw/openclaw/pull/17296",
    "diff_url": "https://github.com/openclaw/openclaw/pull/17296.diff",
    "patch_url": "https://github.com/openclaw/openclaw/pull/17296.patch",
    "merged_at": null
  },
  "body": "Fixes #17270, #16820, #16862, #17223, #17233\n\n---\n\n## Problem\n\nCommit [d8a2c80cd](https://github.com/openclaw/openclaw/commit/d8a2c80cd) (\"fix(gateway): prefer explicit token over stored auth\") introduced a **token priority regression** that breaks device authentication for all non-localhost paired devices.\n\n**Symptom:**\n\nAfter upgrading from v2026.2.13 to v2026.2.14, all previously paired devices (Node, CLI, browser) fail to connect with:\n\n```\nunauthorized: device token mismatch (rotate/reissue device token)\n```\n\nDowngrading to v2026.2.13 **immediately fixes** the issue without any config changes.\n\n**Affected platforms:** Ubuntu, macOS, PopOS, Linux arm64 (#16820, #16862, #17223, #17233)\n\n---\n\n## Root Cause\n\n### The Regression (d8a2c80cd)\n\nThe commit changed `src/gateway/client.ts` line 193:\n\n```diff\n- // v2026.2.13 ‚Äî device token takes priority\n- const authToken = storedToken ?? this.opts.token ?? undefined;\n\n+ // v2026.2.14 ‚Äî config/env token takes priority\n+ const authToken = this.opts.token ?? storedToken ?? undefined;\n```\n\n**Intent:** Allow CLI `--token` to override stored device tokens.\n\n**Problem:** `this.opts.token` contains **both**:\n1. **Explicit CLI overrides** (`--token <value>`) ‚Üê should take priority ‚úÖ\n2. **Config file defaults** (`gateway.token`) ‚Üê should NOT override device tokens ‚ùå\n\nThe commit treated both as \"explicit\" and broke device authentication.\n\n---\n\n### Why It Breaks Device Auth\n\n**Device pairing flow:**\n1. Device pairs with gateway ‚Üí receives **device-specific token**\n2. Token stored locally in `~/.openclaw/auth/devices/<deviceId>.json`\n3. Device connects ‚Üí should send **stored device token**\n\n**In v2026.2.14:**\n- Device has `storedToken` (device-specific) ‚úÖ\n- Config has `gateway.token` (shared gateway token) ‚ö†Ô∏è\n- **Priority:** `opts.token ?? storedToken` ‚Üí sends **shared token** ‚ùå\n- Gateway rejects: **\"device token mismatch\"** ‚ùå\n\n**In v2026.2.13:**\n- **Priority:** `storedToken ?? opts.token` ‚Üí sends **device token** ‚úÖ\n- Gateway accepts ‚úÖ\n\n---\n\n## Solution\n\n**Restore device token priority when `deviceIdentity` is present:**\n\n```typescript\nconst authToken =\n  this.opts.deviceIdentity && storedToken\n    ? storedToken  // ‚úÖ Device-auth mode: use device-specific token\n    : this.opts.token ?? storedToken ?? undefined;  // Shared-auth or fallback\n```\n\n**Logic:**\n- **Device-auth mode** (`deviceIdentity` + `storedToken` exist):\n  - Use stored device token (ignore config `gateway.token`)\n  - Ensures paired devices continue working after config changes/upgrades\n  \n- **Shared-auth mode** (no `deviceIdentity` or no `storedToken`):\n  - Use `opts.token` (CLI `--token` or config `gateway.token`)\n  - Fallback to `storedToken` if available\n\n**Why this is correct:**\n- When a device is paired, `deviceIdentity` is set (contains `deviceId`, `deviceName`)\n- Paired devices **must** use their device-specific token (not shared token)\n- Config `gateway.token` is for **unpaired clients** or **shared authentication**\n\n---\n\n## Impact\n\n### ‚úÖ Fixed\n- Paired devices (Node, CLI, browser) authenticate successfully after v2026.2.14 upgrade\n- Device tokens are respected in device-auth mode\n- Config `gateway.token` still works for unpaired clients\n- **No manual token rotation or re-pairing required**\n\n### ‚úÖ Preserves Original Intent\n- CLI `--token` **still overrides** device token when device is **not yet paired**\n- After pairing, device token takes priority (correct security model)\n\n### üìù Known Limitation\nIf user explicitly wants to override a paired device's token via CLI `--token`:\n1. Clear device token: `rm ~/.openclaw/auth/devices/<deviceId>.json`\n2. Then use `openclaw connect --token <new-token>`\n\n**This is acceptable because:**\n- Overriding paired device tokens is rare (users normally re-pair instead)\n- Device auth is **intentionally sticky** (security best practice)\n- Users can always re-pair to change tokens\n\n---\n\n## Testing\n\n**Manual verification:**\n1. Pair a device on v2026.2.13 (or clean install + this PR)\n2. Verify stored token: `cat ~/.openclaw/auth/devices/<deviceId>.json`\n3. Add `gateway.token` to config (simulating shared token)\n4. Reconnect ‚Üí uses device token, ignores config token ‚úÖ\n\n**Regression check:**\n1. Test on v2026.2.14 (before this PR) ‚Üí fails ‚ùå\n2. Apply this PR ‚Üí succeeds ‚úÖ\n3. Upgrade path: v2026.2.13 ‚Üí v2026.2.14 + PR ‚Üí no breakage ‚úÖ\n\n---\n\n## Related Issues\n\nThis PR fixes **5 issues** sharing the same root cause (d8a2c80cd priority flip):\n\n- #17270 - Device token auth regression in v2026.2.14\n- #16820 - PopOS: device token mismatch after update\n- #16862 - Unauthorized: device token mismatch\n- #17223 - systemd service: device token mismatch\n- #17233 - Safari webchat: requires macOS logout after v2026.2.14\n\nAll reports describe the same pattern:\n1. Works on v2026.2.13 ‚úÖ\n2. Breaks on v2026.2.14 ‚ùå\n3. Downgrade to v2026.2.13 ‚Üí works again ‚úÖ\n\n**Root cause:** Token priority flip in d8a2c80cd.\n\n<!-- greptile_comment -->\n\n<h3>Greptile Summary</h3>\n\nRestores device token priority for paired devices, fixing authentication regression introduced in v2026.2.14. The fix ensures paired devices use their device-specific tokens instead of falling back to config-based gateway tokens, resolving \"unauthorized: device token mismatch\" errors.\n\n- Fixes device authentication regression that broke all paired devices after upgrade\n- Correctly prioritizes stored device tokens when `deviceIdentity` is present\n- Preserves CLI `--token` override capability for unpaired devices\n- Includes additional fixes: QMD backend embedding check skip, service environment token rotation support\n\n<h3>Confidence Score: 5/5</h3>\n\n- This PR is safe to merge with minimal risk\n- The fix directly addresses a critical authentication regression with clear logic: when both `deviceIdentity` and `storedToken` exist, use the device token; otherwise fall back to config/CLI token. The change is minimal (8 lines in gateway/client.ts), well-documented, and restores the correct v2026.2.13 behavior. The PR description provides extensive analysis of the root cause, impact, and testing methodology. Additional changes in the PR are unrelated refactoring and fixes that don't affect the core authentication logic.\n- No files require special attention\n\n<sub>Last reviewed commit: 28612ab</sub>\n\n<!-- greptile_other_comments_section -->\n\n<!-- /greptile_comment -->",
  "closed_by": {
    "login": "openclaw-barnacle[bot]",
    "id": 257215752,
    "node_id": "BOT_kgDOD1TNCA",
    "avatar_url": "https://avatars.githubusercontent.com/in/2729701?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/openclaw-barnacle%5Bbot%5D",
    "html_url": "https://github.com/apps/openclaw-barnacle",
    "followers_url": "https://api.github.com/users/openclaw-barnacle%5Bbot%5D/followers",
    "following_url": "https://api.github.com/users/openclaw-barnacle%5Bbot%5D/following{/other_user}",
    "gists_url": "https://api.github.com/users/openclaw-barnacle%5Bbot%5D/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/openclaw-barnacle%5Bbot%5D/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/openclaw-barnacle%5Bbot%5D/subscriptions",
    "organizations_url": "https://api.github.com/users/openclaw-barnacle%5Bbot%5D/orgs",
    "repos_url": "https://api.github.com/users/openclaw-barnacle%5Bbot%5D/repos",
    "events_url": "https://api.github.com/users/openclaw-barnacle%5Bbot%5D/events{/privacy}",
    "received_events_url": "https://api.github.com/users/openclaw-barnacle%5Bbot%5D/received_events",
    "type": "Bot",
    "user_view_type": "public",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/openclaw/openclaw/issues/17296/reactions",
    "total_count": 2,
    "+1": 2,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/openclaw/openclaw/issues/17296/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
