{
  "url": "https://api.github.com/repos/openclaw/openclaw/issues/10573",
  "repository_url": "https://api.github.com/repos/openclaw/openclaw",
  "labels_url": "https://api.github.com/repos/openclaw/openclaw/issues/10573/labels{/name}",
  "comments_url": "https://api.github.com/repos/openclaw/openclaw/issues/10573/comments",
  "events_url": "https://api.github.com/repos/openclaw/openclaw/issues/10573/events",
  "html_url": "https://github.com/openclaw/openclaw/issues/10573",
  "id": 3907791416,
  "node_id": "I_kwDOQb6kR87o7Co4",
  "number": 10573,
  "title": "Bug Report: Recurring Cron Jobs Never Execute",
  "user": {
    "login": "arctic-ice-cool",
    "id": 22370153,
    "node_id": "MDQ6VXNlcjIyMzcwMTUz",
    "avatar_url": "https://avatars.githubusercontent.com/u/22370153?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/arctic-ice-cool",
    "html_url": "https://github.com/arctic-ice-cool",
    "followers_url": "https://api.github.com/users/arctic-ice-cool/followers",
    "following_url": "https://api.github.com/users/arctic-ice-cool/following{/other_user}",
    "gists_url": "https://api.github.com/users/arctic-ice-cool/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/arctic-ice-cool/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/arctic-ice-cool/subscriptions",
    "organizations_url": "https://api.github.com/users/arctic-ice-cool/orgs",
    "repos_url": "https://api.github.com/users/arctic-ice-cool/repos",
    "events_url": "https://api.github.com/users/arctic-ice-cool/events{/privacy}",
    "received_events_url": "https://api.github.com/users/arctic-ice-cool/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "labels": [],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [],
  "milestone": null,
  "comments": 2,
  "created_at": "2026-02-06T17:42:45Z",
  "updated_at": "2026-02-07T02:05:27Z",
  "closed_at": "2026-02-07T02:05:27Z",
  "author_association": "NONE",
  "type": null,
  "active_lock_reason": null,
  "sub_issues_summary": {
    "total": 0,
    "completed": 0,
    "percent_completed": 0
  },
  "issue_dependencies_summary": {
    "blocked_by": 0,
    "total_blocked_by": 0,
    "blocking": 0,
    "total_blocking": 0
  },
  "body": "# Bug Report: Recurring Cron Jobs Never Execute\n\n## Summary\n\nRecurring cron jobs (both `schedule.kind: \"cron\"` and `schedule.kind: \"every\"`) never execute. The timer fires correctly and `nextRunAtMs` advances, but the job execution is skipped every time.\n\n## Environment\n\n- **OpenClaw Version:** v2026.2.3-1\n- **Node.js:** v22.22.0\n- **OS:** Ubuntu Linux 6.8.0-94-generic (x64)\n- **Cron enabled:** Yes (`cron status` shows `enabled: true`)\n\n## Steps to Reproduce\n\n1. Create a recurring cron job:\n```bash\n# Using cron expression\nopenclaw cron add --name \"Test every minute\" \\\n  --schedule '{\"kind\":\"cron\",\"expr\":\"* * * * *\"}' \\\n  --sessionTarget main \\\n  --payload '{\"kind\":\"systemEvent\",\"text\":\"TEST FIRED\"}'\n\n# Or using \"every\" interval\nopenclaw cron add --name \"Test every 60s\" \\\n  --schedule '{\"kind\":\"every\",\"everyMs\":60000}' \\\n  --sessionTarget main \\\n  --payload '{\"kind\":\"systemEvent\",\"text\":\"TEST FIRED\"}'\n```\n\n2. Check cron status — shows correct `nextWakeAtMs`\n3. Wait for the scheduled time to pass\n4. Check the job again\n\n## Expected Behaviour\n\n- Job executes at scheduled time\n- `state.lastRunAtMs` and `state.lastStatus` are populated\n- Run history shows execution entries\n\n## Actual Behaviour\n\n- Timer fires (confirmed by `nextRunAtMs` advancing)\n- Job does NOT execute\n- `state.lastRunAtMs` remains undefined\n- No run history entries\n- `nextRunAtMs` keeps advancing each interval without any actual execution\n\n## Root Cause Analysis\n\nThe bug is in `onTimer` (in the bundled gateway code):\n\n```javascript\nasync function onTimer(state) {\n    await locked(state, async () => {\n        await ensureLoaded(state, { forceReload: true });  // ← Problem here\n        await runDueJobs(state);\n        await persist(state);\n        armTimer(state);\n    });\n}\n```\n\n`ensureLoaded` calls `recomputeNextRuns(state)` which iterates all jobs and updates their `nextRunAtMs` to the **next** occurrence based on `nowMs`.\n\nThen `runDueJobs` checks:\n```javascript\nconst due = state.store.jobs.filter((j) => {\n    // ...\n    return typeof next === \"number\" && now >= next;\n});\n```\n\nBut by this point, `nextRunAtMs` has already been updated to a future time, so `now >= next` is always `false`.\n\n### Timeline Example\n\n1. Job scheduled for 10:00:00\n2. Timer fires at 10:00:01\n3. `ensureLoaded` → `recomputeNextRuns` → `nextRunAtMs` updated to 10:01:00\n4. `runDueJobs` checks: 10:00:01 >= 10:01:00 → FALSE\n5. Job skipped, timer re-armed for 10:01:00\n6. Repeat forever\n\n## Suggested Fix\n\nOption A: Don't call `recomputeNextRuns` during timer callback:\n```javascript\nasync function ensureLoaded(state, opts) {\n    // ... load store ...\n    if (!opts?.skipRecompute) {\n        recomputeNextRuns(state);\n    }\n}\n\n// In onTimer:\nawait ensureLoaded(state, { forceReload: true, skipRecompute: true });\n```\n\nOption B: Check due jobs BEFORE recomputing:\n```javascript\nasync function onTimer(state) {\n    await locked(state, async () => {\n        await ensureLoaded(state, { forceReload: true, skipRecompute: true });\n        await runDueJobs(state);  // Check against OLD nextRunAtMs values\n        recomputeNextRuns(state); // Then update for next cycle\n        await persist(state);\n        armTimer(state);\n    });\n}\n```\n\n## Workaround\n\nOne-shot jobs (`schedule.kind: \"at\"`) work correctly. Users can create multiple one-shot jobs as a workaround for recurring schedules.\n\n## Impact\n\n- **Severity:** High — recurring cron jobs are completely non-functional\n- **Affected:** All users relying on `cron` or `every` schedule types\n- One-shot `at` jobs are unaffected\n\n## Additional Notes\n\n- The croner library parses expressions correctly (verified independently)\n- Job state persists correctly to disk\n- Timer mechanism works (fires at correct times)\n- Only the execution step is broken due to the race with `recomputeNextRuns`",
  "closed_by": {
    "login": "tyler6204",
    "id": 64381258,
    "node_id": "MDQ6VXNlcjY0MzgxMjU4",
    "avatar_url": "https://avatars.githubusercontent.com/u/64381258?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tyler6204",
    "html_url": "https://github.com/tyler6204",
    "followers_url": "https://api.github.com/users/tyler6204/followers",
    "following_url": "https://api.github.com/users/tyler6204/following{/other_user}",
    "gists_url": "https://api.github.com/users/tyler6204/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tyler6204/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tyler6204/subscriptions",
    "organizations_url": "https://api.github.com/users/tyler6204/orgs",
    "repos_url": "https://api.github.com/users/tyler6204/repos",
    "events_url": "https://api.github.com/users/tyler6204/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tyler6204/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/openclaw/openclaw/issues/10573/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/openclaw/openclaw/issues/10573/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed",
  "pinned_comment": null
}
