{
  "url": "https://api.github.com/repos/openclaw/openclaw/issues/3620",
  "repository_url": "https://api.github.com/repos/openclaw/openclaw",
  "labels_url": "https://api.github.com/repos/openclaw/openclaw/issues/3620/labels{/name}",
  "comments_url": "https://api.github.com/repos/openclaw/openclaw/issues/3620/comments",
  "events_url": "https://api.github.com/repos/openclaw/openclaw/issues/3620/events",
  "html_url": "https://github.com/openclaw/openclaw/pull/3620",
  "id": 3867763882,
  "node_id": "PR_kwDOQb6kR86_-nSR",
  "number": 3620,
  "title": "feat(auth): auto-sync CLI credentials on OAuth refresh failure",
  "user": {
    "login": "kira-ariaki",
    "id": 257352493,
    "node_id": "U_kgDOD1bjLQ",
    "avatar_url": "https://avatars.githubusercontent.com/u/257352493?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/kira-ariaki",
    "html_url": "https://github.com/kira-ariaki",
    "followers_url": "https://api.github.com/users/kira-ariaki/followers",
    "following_url": "https://api.github.com/users/kira-ariaki/following{/other_user}",
    "gists_url": "https://api.github.com/users/kira-ariaki/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/kira-ariaki/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/kira-ariaki/subscriptions",
    "organizations_url": "https://api.github.com/users/kira-ariaki/orgs",
    "repos_url": "https://api.github.com/users/kira-ariaki/repos",
    "events_url": "https://api.github.com/users/kira-ariaki/events{/privacy}",
    "received_events_url": "https://api.github.com/users/kira-ariaki/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "labels": [
    {
      "id": 10069976942,
      "node_id": "LA_kwDOQb6kR88AAAACWDenbg",
      "url": "https://api.github.com/repos/openclaw/openclaw/labels/agents",
      "name": "agents",
      "color": "5319e7",
      "default": false,
      "description": "Agent runtime and tooling"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [],
  "milestone": null,
  "comments": 1,
  "created_at": "2026-01-28T22:44:46Z",
  "updated_at": "2026-02-01T00:05:10Z",
  "closed_at": "2026-02-01T00:05:10Z",
  "author_association": "CONTRIBUTOR",
  "type": null,
  "active_lock_reason": null,
  "draft": false,
  "pull_request": {
    "url": "https://api.github.com/repos/openclaw/openclaw/pulls/3620",
    "html_url": "https://github.com/openclaw/openclaw/pull/3620",
    "diff_url": "https://github.com/openclaw/openclaw/pull/3620.diff",
    "patch_url": "https://github.com/openclaw/openclaw/pull/3620.patch",
    "merged_at": null
  },
  "body": "When OAuth token refresh fails for `anthropic:claude-cli` or `openai-codex:codex-cli` profiles, attempt to recover by syncing fresh credentials from the external CLI tools (Claude Code CLI or Codex CLI).\n\nThis handles the common case where Clawdbot and the CLI tool race to refresh tokens - one wins, and the other's refresh token gets revoked. Previously this required manual intervention (running `clawdbot models status`). Now recovery is automatic.\n\n## Changes\n\n- **`external-cli-sync.ts`**: Added `trySyncClaudeCliCredentialsOnRefreshFailure()` and `trySyncCodexCliCredentialsOnRefreshFailure()` functions\n- **`oauth.ts`**: Call the sync functions in the catch block when OAuth refresh fails\n\n## How it works\n\n1. OAuth refresh fails (e.g., token revoked)\n2. Check if the profile is `anthropic:claude-cli` or `openai-codex:codex-cli`\n3. Attempt to read fresh credentials from the external CLI tool\n4. If successful and credentials are newer, sync them and retry\n5. If sync also fails, continue with existing fallback logic\n\nFixes #3615",
  "closed_by": {
    "login": "clawdinator[bot]",
    "id": 253378751,
    "node_id": "BOT_kgDODxpAvw",
    "avatar_url": "https://avatars.githubusercontent.com/in/2607181?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/clawdinator%5Bbot%5D",
    "html_url": "https://github.com/apps/clawdinator",
    "followers_url": "https://api.github.com/users/clawdinator%5Bbot%5D/followers",
    "following_url": "https://api.github.com/users/clawdinator%5Bbot%5D/following{/other_user}",
    "gists_url": "https://api.github.com/users/clawdinator%5Bbot%5D/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/clawdinator%5Bbot%5D/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/clawdinator%5Bbot%5D/subscriptions",
    "organizations_url": "https://api.github.com/users/clawdinator%5Bbot%5D/orgs",
    "repos_url": "https://api.github.com/users/clawdinator%5Bbot%5D/repos",
    "events_url": "https://api.github.com/users/clawdinator%5Bbot%5D/events{/privacy}",
    "received_events_url": "https://api.github.com/users/clawdinator%5Bbot%5D/received_events",
    "type": "Bot",
    "user_view_type": "public",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/openclaw/openclaw/issues/3620/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/openclaw/openclaw/issues/3620/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
