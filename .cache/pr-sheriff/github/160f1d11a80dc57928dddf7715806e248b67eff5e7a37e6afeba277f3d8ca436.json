{
  "url": "https://api.github.com/repos/openclaw/openclaw/issues/4302",
  "repository_url": "https://api.github.com/repos/openclaw/openclaw",
  "labels_url": "https://api.github.com/repos/openclaw/openclaw/issues/4302/labels{/name}",
  "comments_url": "https://api.github.com/repos/openclaw/openclaw/issues/4302/comments",
  "events_url": "https://api.github.com/repos/openclaw/openclaw/issues/4302/events",
  "html_url": "https://github.com/openclaw/openclaw/issues/4302",
  "id": 3873393058,
  "node_id": "I_kwDOQb6kR87m30mi",
  "number": 4302,
  "title": "Telegram polling dies silently — runner.task() resolves without error, no restart",
  "user": {
    "login": "reallygood83",
    "id": 193194902,
    "node_id": "U_kgDOC4Prlg",
    "avatar_url": "https://avatars.githubusercontent.com/u/193194902?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/reallygood83",
    "html_url": "https://github.com/reallygood83",
    "followers_url": "https://api.github.com/users/reallygood83/followers",
    "following_url": "https://api.github.com/users/reallygood83/following{/other_user}",
    "gists_url": "https://api.github.com/users/reallygood83/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/reallygood83/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/reallygood83/subscriptions",
    "organizations_url": "https://api.github.com/users/reallygood83/orgs",
    "repos_url": "https://api.github.com/users/reallygood83/repos",
    "events_url": "https://api.github.com/users/reallygood83/events{/privacy}",
    "received_events_url": "https://api.github.com/users/reallygood83/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "labels": [
    {
      "id": 9706244967,
      "node_id": "LA_kwDOQb6kR88AAAACQomLZw",
      "url": "https://api.github.com/repos/openclaw/openclaw/labels/bug",
      "name": "bug",
      "color": "d73a4a",
      "default": true,
      "description": "Something isn't working"
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [],
  "milestone": null,
  "comments": 1,
  "created_at": "2026-01-30T01:35:34Z",
  "updated_at": "2026-02-05T05:19:34Z",
  "closed_at": null,
  "author_association": "NONE",
  "type": null,
  "active_lock_reason": null,
  "sub_issues_summary": {
    "total": 0,
    "completed": 0,
    "percent_completed": 0
  },
  "issue_dependencies_summary": {
    "blocked_by": 0,
    "total_blocked_by": 0,
    "blocking": 0,
    "total_blocking": 0
  },
  "body": "## Summary\n\nThe Telegram long-polling loop can **silently stop** while the gateway process remains alive. The grammY runner's `task()` promise resolves without error when `maxRetryTime` is exceeded, causing the polling `while` loop to exit via `return`. No restart logic exists, so the bot becomes permanently unresponsive until manual restart.\n\nA related issue: when a channel's `startAccount` task crashes or exits, the `.catch()` logs the error and `.finally()` sets `running: false` — but **never restarts the channel**.\n\n## Root Cause\n\n### Bug 1: `src/telegram/monitor.ts` — polling exits on silent resolve\n\n```typescript\n// BEFORE (broken): runner.task() resolves → return exits the while loop forever\nawait runner.task();\nreturn; // ← this kills the polling loop silently\n```\n\nWhen grammY's internal retry window (`maxRetryTime: 5min`) is exhausted (e.g., Telegram API unreachable for >5 min), `runner.task()` resolves cleanly (no error). The `return` statement exits `monitorTelegramProvider()`, and the channel marks `running: false`. The bot never polls again.\n\n### Bug 2: `src/gateway/server-channels.ts` — no channel restart on crash\n\nWhen `startAccount()` throws or resolves unexpectedly, the promise chain logs the error but never restarts the channel. The channel is permanently dead until gateway restart.\n\n## Observed Behavior\n\n- Gateway process alive for 9+ hours (PID visible, port listening)\n- **Zero** outbound TCP connections to Telegram API (`lsof -i` shows no `149.154.x.x`)\n- Last log entry: `\"[default] channel exited: Request to 'getUpdates' timed out after 500 seconds\"`\n- Bot completely unresponsive to Telegram messages\n- Only fix: manual `launchctl stop/start`\n\n## Proposed Fix (implemented locally, tested)\n\n### Fix 1: Auto-restart polling on unexpected stop\n\nReplace `return` with backoff + `continue` in the polling loop. Only exit when `abortSignal` is aborted:\n\n```typescript\n// AFTER: treat silent resolve as recoverable, restart with backoff\nawait runner.task();\nif (opts.abortSignal?.aborted) return; // intentional stop — exit cleanly\nrestartAttempts += 1;\nconst delayMs = computeBackoff(TELEGRAM_POLL_RESTART_POLICY, restartAttempts);\nlog(`Telegram polling stopped unexpectedly; restarting in ${formatDurationMs(delayMs)}.`);\nawait sleepWithAbort(delayMs, opts.abortSignal);\n// continue → loops back to create a new runner\n```\n\n### Fix 2: Auto-restart channels with exponential backoff\n\nWrap `startAccount()` in `runAccountWithRestart()` — a while loop with exponential backoff (3s initial, 60s max, factor 2, jitter 0.2) that auto-restarts crashed channels up to 20 times:\n\n```typescript\nconst runAccountWithRestart = async () => {\n  let restartAttempts = 0;\n  while (!abort.signal.aborted) {\n    try {\n      await startAccount({ ... });\n      if (abort.signal.aborted) return;\n      restartAttempts += 1;\n      if (restartAttempts > MAX_CHANNEL_RESTART_ATTEMPTS) { /* give up */ return; }\n      const delayMs = computeBackoff(CHANNEL_RESTART_POLICY, restartAttempts);\n      log(`channel stopped unexpectedly; restarting in ${formatDurationMs(delayMs)}`);\n      await sleepWithAbort(delayMs, abort.signal);\n    } catch (err) {\n      // same pattern: backoff + restart, give up after MAX attempts\n    }\n  }\n};\n```\n\n### Fix 3: Active Telegram health check (new)\n\nPeriodically call `bot.api.getMe()` (every 60s) to verify Telegram API connectivity. After 3 consecutive failures, force-stop the runner — which triggers the existing restart loop:\n\n```typescript\nconst stopHealthCheck = startPollingHealthCheck({\n  bot,\n  intervalMs: 60_000,\n  maxFailures: 3,\n  timeoutMs: 10_000,\n  onUnhealthy: () => void runner.stop(),\n  signal: opts.abortSignal,\n});\n```\n\n### Fix 4: Process-level self-watchdog (new)\n\nDetect event loop hangs via `setInterval` drift detection. If the event loop is unresponsive for >30s, force `process.exit(1)` so launchd (`KeepAlive: true`) auto-restarts the gateway:\n\n```typescript\nexport function startWatchdog(opts?: WatchdogOptions, signal?: AbortSignal): () => void {\n  let lastTick = Date.now();\n  const timer = setInterval(() => {\n    const delta = Date.now() - lastTick;\n    if (delta > thresholdMs) process.exit(1);\n    lastTick = Date.now();\n  }, intervalMs);\n  timer.unref();\n  return () => clearInterval(timer);\n}\n```\n\n## Environment\n\n- macOS (Mac mini, LaunchAgent with KeepAlive)\n- Node.js 22\n- grammY + @grammyjs/runner\n- Long-polling mode (not webhook)\n\n## Related Issues\n\n- #4248 — Gateway crashes on unhandled fetch rejection\n- #3815 — Clawdbot Gateway Crashes Repeatedly\n- #3646 — Multiple Critical Channel Bugs (Telegram, AbortError)\n- #2935 — Heartbeat stops after context compression\n- #1964 — Telegram channel goes silent periodically\n\n## Files Changed\n\n1. `src/telegram/monitor.ts` — polling restart loop + health check integration\n2. `src/gateway/server-channels.ts` — `runAccountWithRestart()` with backoff\n3. `src/infra/watchdog.ts` — new process self-watchdog\n4. `src/gateway/server.impl.ts` — watchdog lifecycle integration\n5. Tests: `monitor.test.ts` (9 tests), `watchdog.test.ts` (4 tests)\n\nAll tests pass. Build clean. Lint clean.",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/openclaw/openclaw/issues/4302/reactions",
    "total_count": 3,
    "+1": 3,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/openclaw/openclaw/issues/4302/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
