{
  "url": "https://api.github.com/repos/openclaw/openclaw/issues/10138",
  "repository_url": "https://api.github.com/repos/openclaw/openclaw",
  "labels_url": "https://api.github.com/repos/openclaw/openclaw/issues/10138/labels{/name}",
  "comments_url": "https://api.github.com/repos/openclaw/openclaw/issues/10138/comments",
  "events_url": "https://api.github.com/repos/openclaw/openclaw/issues/10138/events",
  "html_url": "https://github.com/openclaw/openclaw/issues/10138",
  "id": 3904968134,
  "node_id": "I_kwDOQb6kR87owRXG",
  "number": 10138,
  "title": "Recurring cron jobs never fire - timer recomputes nextRunAtMs before checking if due",
  "user": {
    "login": "clawdbotjohn-crypto",
    "id": 258366309,
    "node_id": "U_kgDOD2ZbZQ",
    "avatar_url": "https://avatars.githubusercontent.com/u/258366309?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/clawdbotjohn-crypto",
    "html_url": "https://github.com/clawdbotjohn-crypto",
    "followers_url": "https://api.github.com/users/clawdbotjohn-crypto/followers",
    "following_url": "https://api.github.com/users/clawdbotjohn-crypto/following{/other_user}",
    "gists_url": "https://api.github.com/users/clawdbotjohn-crypto/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/clawdbotjohn-crypto/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/clawdbotjohn-crypto/subscriptions",
    "organizations_url": "https://api.github.com/users/clawdbotjohn-crypto/orgs",
    "repos_url": "https://api.github.com/users/clawdbotjohn-crypto/repos",
    "events_url": "https://api.github.com/users/clawdbotjohn-crypto/events{/privacy}",
    "received_events_url": "https://api.github.com/users/clawdbotjohn-crypto/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "labels": [],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [],
  "milestone": null,
  "comments": 2,
  "created_at": "2026-02-06T05:28:34Z",
  "updated_at": "2026-02-07T02:04:47Z",
  "closed_at": "2026-02-07T02:04:47Z",
  "author_association": "NONE",
  "type": null,
  "active_lock_reason": null,
  "sub_issues_summary": {
    "total": 0,
    "completed": 0,
    "percent_completed": 0
  },
  "issue_dependencies_summary": {
    "blocked_by": 0,
    "total_blocked_by": 0,
    "blocking": 0,
    "total_blocking": 0
  },
  "body": "## Description\n\nRecurring cron jobs (`every` and `cron` schedule types) never fire automatically. One-shot `at` jobs work fine.\n\n## Version\n\n`2026.2.3-1`\n\n## Root Cause Analysis\n\nRace condition in `onTimer()` function in `gateway-cli-D_8miTjF.js`:\n\n```javascript\nasync function onTimer(state) {\n  // ...\n  await ensureLoaded(state, { forceReload: true });  // This recalculates nextRunAtMs!\n  await runDueJobs(state);  // By now, nextRunAtMs is in the future\n  // ...\n}\n```\n\nThe issue:\n1. Timer fires at scheduled time (e.g., 21:27:29)\n2. `ensureLoaded(state, { forceReload: true })` is called\n3. This calls `recomputeNextRuns()` which recalculates `nextRunAtMs` for all jobs based on **current time**\n4. For `every` type: `computeNextRunAtMs()` returns the next interval slot\n5. For `cron` type: the cron library returns the next matching time\n6. Then `runDueJobs()` checks `now >= nextRunAtMs` — but it was just moved forward, so nothing is \"due\"\n7. Job never executes, timer rearms for next slot, cycle repeats forever\n\n## Evidence\n\nCreated a 2-minute interval test job. Observed:\n- Original `nextRunAtMs`: 21:27:29\n- After timer fired: `nextRunAtMs` jumped to 21:29:29\n- No run entries recorded\n- `lastRunAtMs` remains null\n\nFor cron expression jobs like `0 6,12,18 * * *`:\n- `lastRunAtMs`: Wed Feb 4 18:00 (yesterday)\n- `nextRunAtMs`: Fri Feb 6 06:00 (tomorrow)\n- Skipped Thu Feb 5 12:00 AND 18:00 runs entirely\n\n## Steps to Reproduce\n\n1. Create an `every` type job with short interval:\n```json\n{\n  \"schedule\": { \"kind\": \"every\", \"everyMs\": 120000 },\n  \"payload\": { \"kind\": \"agentTurn\", \"message\": \"test\" },\n  \"sessionTarget\": \"isolated\"\n}\n```\n\n2. Wait for scheduled time to pass\n3. Check `cron runs <jobId>` — will show no entries\n4. Check job state — `nextRunAtMs` will have advanced by one interval\n\n## What Works\n\n- One-shot `at` jobs fire correctly (fixed timestamp doesn't get recalculated)\n- Manual `cron run --force <jobId>` works (bypasses `isJobDue` check)\n- Spawned sessions work fine\n\n## Suggested Fix\n\nOption A: Don't recalculate `nextRunAtMs` in `ensureLoaded` when called from `onTimer`:\n```javascript\nasync function onTimer(state) {\n  await ensureLoaded(state, { forceReload: true, skipRecompute: true });\n  await runDueJobs(state);\n  // ...\n}\n```\n\nOption B: Save the scheduled times before reload and use those to check if jobs were due:\n```javascript\nconst dueAtMs = state.store.jobs.map(j => ({ id: j.id, dueAt: j.state.nextRunAtMs }));\nawait ensureLoaded(state, { forceReload: true });\n// Use dueAtMs to determine which jobs should run\n```\n\nOption C: Check if job was due at the timer's scheduled time, not current time\n\n## Environment\n\n- OpenClaw 2026.2.3-1\n- Raspberry Pi 4 (arm64)\n- Node.js v22.22.0\n- Linux 6.12.62+rpt-rpi-v8\n",
  "closed_by": {
    "login": "tyler6204",
    "id": 64381258,
    "node_id": "MDQ6VXNlcjY0MzgxMjU4",
    "avatar_url": "https://avatars.githubusercontent.com/u/64381258?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tyler6204",
    "html_url": "https://github.com/tyler6204",
    "followers_url": "https://api.github.com/users/tyler6204/followers",
    "following_url": "https://api.github.com/users/tyler6204/following{/other_user}",
    "gists_url": "https://api.github.com/users/tyler6204/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tyler6204/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tyler6204/subscriptions",
    "organizations_url": "https://api.github.com/users/tyler6204/orgs",
    "repos_url": "https://api.github.com/users/tyler6204/repos",
    "events_url": "https://api.github.com/users/tyler6204/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tyler6204/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/openclaw/openclaw/issues/10138/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/openclaw/openclaw/issues/10138/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed",
  "pinned_comment": null
}
