{
  "url": "https://api.github.com/repos/openclaw/openclaw/issues/9661",
  "repository_url": "https://api.github.com/repos/openclaw/openclaw",
  "labels_url": "https://api.github.com/repos/openclaw/openclaw/issues/9661/labels{/name}",
  "comments_url": "https://api.github.com/repos/openclaw/openclaw/issues/9661/comments",
  "events_url": "https://api.github.com/repos/openclaw/openclaw/issues/9661/events",
  "html_url": "https://github.com/openclaw/openclaw/issues/9661",
  "id": 3901985464,
  "node_id": "I_kwDOQb6kR87ok5K4",
  "number": 9661,
  "title": "[Bug]: Cron jobs skipped due to race condition - recomputeNextRuns called before runDueJobs",
  "user": {
    "login": "chrichts",
    "id": 84300304,
    "node_id": "MDQ6VXNlcjg0MzAwMzA0",
    "avatar_url": "https://avatars.githubusercontent.com/u/84300304?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/chrichts",
    "html_url": "https://github.com/chrichts",
    "followers_url": "https://api.github.com/users/chrichts/followers",
    "following_url": "https://api.github.com/users/chrichts/following{/other_user}",
    "gists_url": "https://api.github.com/users/chrichts/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/chrichts/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/chrichts/subscriptions",
    "organizations_url": "https://api.github.com/users/chrichts/orgs",
    "repos_url": "https://api.github.com/users/chrichts/repos",
    "events_url": "https://api.github.com/users/chrichts/events{/privacy}",
    "received_events_url": "https://api.github.com/users/chrichts/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "labels": [],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [],
  "milestone": null,
  "comments": 6,
  "created_at": "2026-02-05T14:53:11Z",
  "updated_at": "2026-02-07T02:06:09Z",
  "closed_at": "2026-02-07T02:06:09Z",
  "author_association": "NONE",
  "type": null,
  "active_lock_reason": null,
  "sub_issues_summary": {
    "total": 0,
    "completed": 0,
    "percent_completed": 0
  },
  "issue_dependencies_summary": {
    "blocked_by": 0,
    "total_blocked_by": 0,
    "blocking": 0,
    "total_blocking": 0
  },
  "body": "## Summary\n\nCron jobs are systematically skipped when the timer fires even 1ms after the scheduled time due to a race condition in the timer execution order. This is a **root cause** for many of the recent cron-related bug reports (#8424, #8298, #9542, #9575, etc.).\n\n## Root Cause Analysis\n\nIn `src/cron/service/timer.ts`, the `onTimer` function calls operations in this order:\n\n```typescript\nawait locked(state, async () => {\n  await ensureLoaded(state, { forceReload: true }); // ← Calls recomputeNextRuns\n  await runDueJobs(state);                          // ← Too late, nextRunAtMs already advanced\n  await persist(state);\n  armTimer(state);\n});\n```\n\nThe problem:\n1. `ensureLoaded` calls `recomputeNextRuns()` at line 259 of `store.ts`\n2. `recomputeNextRuns` uses `croner.nextRun(new Date(nowMs))` to calculate `nextRunAtMs`\n3. If `nowMs` is **12:00:00.001** (1ms past scheduled time), `croner.nextRun()` returns **14:00:00.000** (next occurrence)\n4. `runDueJobs` then checks `now >= nextRunAtMs` → **12:00:00.001 >= 14:00:00.000** → **false** → job skipped\n\n## Reproduction\n\n```javascript\nconst { Cron } = require(\"croner\");\n\n// Job scheduled for every 2 hours at minute 0\nconst cron = new Cron(\"0 */2 * * *\");\n\n// Timer fires 1ms late\nconst nowMs = Date.parse(\"2026-02-05T12:00:00.001Z\");\nconst next = cron.nextRun(new Date(nowMs));\n\nconsole.log(\"Timer fired at:\", new Date(nowMs).toISOString());\nconsole.log(\"Next run calculated as:\", next.toISOString());\n// Output: Timer fired at: 2026-02-05T12:00:00.001Z\n//         Next run calculated as: 2026-02-05T14:00:00.000Z\n// The 12:00 run is SKIPPED because nextRunAtMs is now 14:00\n```\n\n## Impact\n\n- **Every cron job** is at risk of being skipped\n- `setTimeout` has inherent imprecision (~1-4ms minimum)\n- System load, GC pauses, or VM scheduling delays make this worse\n- Jobs are randomly skipped in normal operation, not just after crashes/restarts\n\n## Proposed Fix\n\nReorder operations in `onTimer` to run due jobs **before** recomputing:\n\n```typescript\nawait locked(state, async () => {\n  await ensureLoaded(state, { forceReload: true, skipRecompute: true });\n  await runDueJobs(state);      // Check stored nextRunAtMs values first\n  recomputeNextRuns(state);     // THEN advance to next occurrence\n  await persist(state);\n  armTimer(state);\n});\n```\n\nThis requires:\n1. Adding `skipRecompute` option to `ensureLoaded`\n2. Calling `recomputeNextRuns` explicitly after `runDueJobs`\n\n## Environment\n\n- OpenClaw version: 2026.2.x (regression appears in 2026.2.1+)\n- Affects all platforms\n\n## Related Issues\n\nThis is likely the root cause for:\n- #8424 - Cron scheduler bug: missed runs cause permanent stall\n- #8298 - Cron Reminders Skipping/Silent Failure\n- #9542 - Cron scheduler timer not firing\n- #9575 - [Critical] Cron scheduler completely unresponsive\n- #9640 - Cron job with timezone not executing\n- And many others filed since Feb 2\n\n## Labels\n\nbug, cron, scheduler, regression",
  "closed_by": {
    "login": "tyler6204",
    "id": 64381258,
    "node_id": "MDQ6VXNlcjY0MzgxMjU4",
    "avatar_url": "https://avatars.githubusercontent.com/u/64381258?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tyler6204",
    "html_url": "https://github.com/tyler6204",
    "followers_url": "https://api.github.com/users/tyler6204/followers",
    "following_url": "https://api.github.com/users/tyler6204/following{/other_user}",
    "gists_url": "https://api.github.com/users/tyler6204/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tyler6204/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tyler6204/subscriptions",
    "organizations_url": "https://api.github.com/users/tyler6204/orgs",
    "repos_url": "https://api.github.com/users/tyler6204/repos",
    "events_url": "https://api.github.com/users/tyler6204/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tyler6204/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/openclaw/openclaw/issues/9661/reactions",
    "total_count": 1,
    "+1": 1,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/openclaw/openclaw/issues/9661/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed",
  "pinned_comment": null
}
