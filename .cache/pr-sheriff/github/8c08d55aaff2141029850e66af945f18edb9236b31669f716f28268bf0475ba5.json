{
  "url": "https://api.github.com/repos/openclaw/openclaw/issues/10988",
  "repository_url": "https://api.github.com/repos/openclaw/openclaw",
  "labels_url": "https://api.github.com/repos/openclaw/openclaw/issues/10988/labels{/name}",
  "comments_url": "https://api.github.com/repos/openclaw/openclaw/issues/10988/comments",
  "events_url": "https://api.github.com/repos/openclaw/openclaw/issues/10988/events",
  "html_url": "https://github.com/openclaw/openclaw/pull/10988",
  "id": 3909755303,
  "node_id": "PR_kwDOQb6kR87CJqFW",
  "number": 10988,
  "title": "cron: fix #10934 - preserve future nextRunAtMs in recomputeNextRuns",
  "user": {
    "login": "Saman-dev12",
    "id": 132365157,
    "node_id": "U_kgDOB-O7ZQ",
    "avatar_url": "https://avatars.githubusercontent.com/u/132365157?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/Saman-dev12",
    "html_url": "https://github.com/Saman-dev12",
    "followers_url": "https://api.github.com/users/Saman-dev12/followers",
    "following_url": "https://api.github.com/users/Saman-dev12/following{/other_user}",
    "gists_url": "https://api.github.com/users/Saman-dev12/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/Saman-dev12/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/Saman-dev12/subscriptions",
    "organizations_url": "https://api.github.com/users/Saman-dev12/orgs",
    "repos_url": "https://api.github.com/users/Saman-dev12/repos",
    "events_url": "https://api.github.com/users/Saman-dev12/events{/privacy}",
    "received_events_url": "https://api.github.com/users/Saman-dev12/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "labels": [],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [],
  "milestone": null,
  "comments": 2,
  "created_at": "2026-02-07T08:07:07Z",
  "updated_at": "2026-02-08T03:47:24Z",
  "closed_at": "2026-02-08T03:47:24Z",
  "author_association": "NONE",
  "type": null,
  "active_lock_reason": null,
  "draft": false,
  "pull_request": {
    "url": "https://api.github.com/repos/openclaw/openclaw/pulls/10988",
    "html_url": "https://github.com/openclaw/openclaw/pull/10988",
    "diff_url": "https://github.com/openclaw/openclaw/pull/10988.diff",
    "patch_url": "https://github.com/openclaw/openclaw/pull/10988.patch",
    "merged_at": null
  },
  "body": "Fixes #10934\r\n\r\n## Problem\r\nCron jobs with `schedule.kind: \"every\"` never executed automatically because `recomputeNextRuns()` unconditionally recalculated all `nextRunAtMs` values before checking for due jobs. For \"every\" schedules without `anchorMs`, this used the current time as anchor, pushing all scheduled times forward before `runDueJobs()` could execute them.\r\n\r\n## Solution\r\nModified `recomputeNextRuns()` in `src/cron/service/jobs.ts` to preserve existing `nextRunAtMs` values when they are valid and in the future. Only recalculate when:\r\n- Job has no `nextRunAtMs` yet\r\n- `nextRunAtMs` is in the past (job is due)\r\n- Job state is invalid\r\n\r\n## Changes\r\n- **src/cron/service/jobs.ts**: Added check to preserve valid future `nextRunAtMs` in `recomputeNextRuns()`\r\n- **src/cron/service.issue-regressions.test.ts**: Added regression test that verifies jobs execute on schedule without time drift\r\n\r\n## Testing\r\n- Added specific regression test for issue #10934\r\n- All 87 cron tests pass\r\n- Verified jobs execute on schedule without continuous rescheduling\n\n<!-- greptile_comment -->\n\n<h2>Greptile Overview</h2>\n\n<h3>Greptile Summary</h3>\n\n- Updates `recomputeNextRuns()` to keep an already-scheduled future `nextRunAtMs` instead of always recomputing it, addressing “every” schedules without an explicit anchor being pushed forward.\n- Adds a regression test for issue #10934 to ensure `nextRunAtMs` isn’t continuously rescheduled and the job actually executes when due.\n- Change interacts with the scheduler loop in `src/cron/service/timer.ts` where recomputation happens when no jobs are due and after executions to persist updated state.\n\n<h3>Confidence Score: 3/5</h3>\n\n- Mostly safe, but there are a couple edge cases/tests that should be tightened before merge.\n- Core behavioral change is small and aligns with scheduler flow, but the guard should only accept valid finite timestamps, and the added regression test’s use of Date.now() deltas under fake timers risks flakiness.\n- src/cron/service/jobs.ts, src/cron/service.issue-regressions.test.ts\n\n<!-- greptile_other_comments_section -->\n\n<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>\n\n<!-- /greptile_comment -->",
  "closed_by": {
    "login": "tyler6204",
    "id": 64381258,
    "node_id": "MDQ6VXNlcjY0MzgxMjU4",
    "avatar_url": "https://avatars.githubusercontent.com/u/64381258?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tyler6204",
    "html_url": "https://github.com/tyler6204",
    "followers_url": "https://api.github.com/users/tyler6204/followers",
    "following_url": "https://api.github.com/users/tyler6204/following{/other_user}",
    "gists_url": "https://api.github.com/users/tyler6204/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tyler6204/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tyler6204/subscriptions",
    "organizations_url": "https://api.github.com/users/tyler6204/orgs",
    "repos_url": "https://api.github.com/users/tyler6204/repos",
    "events_url": "https://api.github.com/users/tyler6204/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tyler6204/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/openclaw/openclaw/issues/10988/reactions",
    "total_count": 2,
    "+1": 2,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/openclaw/openclaw/issues/10988/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
