{
  "url": "https://api.github.com/repos/openclaw/openclaw/issues/17279",
  "repository_url": "https://api.github.com/repos/openclaw/openclaw",
  "labels_url": "https://api.github.com/repos/openclaw/openclaw/issues/17279/labels{/name}",
  "comments_url": "https://api.github.com/repos/openclaw/openclaw/issues/17279/comments",
  "events_url": "https://api.github.com/repos/openclaw/openclaw/issues/17279/events",
  "html_url": "https://github.com/openclaw/openclaw/pull/17279",
  "id": 3944377773,
  "node_id": "PR_kwDOQb6kR87D7X70",
  "number": 17279,
  "title": "fix: restore device token priority over config token",
  "user": {
    "login": "MisterGuy420",
    "id": 255743668,
    "node_id": "U_kgDODz5WtA",
    "avatar_url": "https://avatars.githubusercontent.com/u/255743668?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/MisterGuy420",
    "html_url": "https://github.com/MisterGuy420",
    "followers_url": "https://api.github.com/users/MisterGuy420/followers",
    "following_url": "https://api.github.com/users/MisterGuy420/following{/other_user}",
    "gists_url": "https://api.github.com/users/MisterGuy420/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/MisterGuy420/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/MisterGuy420/subscriptions",
    "organizations_url": "https://api.github.com/users/MisterGuy420/orgs",
    "repos_url": "https://api.github.com/users/MisterGuy420/repos",
    "events_url": "https://api.github.com/users/MisterGuy420/events{/privacy}",
    "received_events_url": "https://api.github.com/users/MisterGuy420/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "labels": [
    {
      "id": 10064298857,
      "node_id": "LA_kwDOQb6kR88AAAACV-EDaQ",
      "url": "https://api.github.com/repos/openclaw/openclaw/labels/gateway",
      "name": "gateway",
      "color": "d4c5f9",
      "default": false,
      "description": "Gateway runtime"
    },
    {
      "id": 10190106613,
      "node_id": "LA_kwDOQb6kR88AAAACX2Cv9Q",
      "url": "https://api.github.com/repos/openclaw/openclaw/labels/size:%20XS",
      "name": "size: XS",
      "color": "b76e79",
      "default": false,
      "description": null
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [],
  "milestone": null,
  "comments": 0,
  "created_at": "2026-02-15T16:07:15Z",
  "updated_at": "2026-02-15T18:46:03Z",
  "closed_at": null,
  "author_association": "CONTRIBUTOR",
  "type": null,
  "active_lock_reason": null,
  "draft": false,
  "pull_request": {
    "url": "https://api.github.com/repos/openclaw/openclaw/pulls/17279",
    "html_url": "https://github.com/openclaw/openclaw/pull/17279",
    "diff_url": "https://github.com/openclaw/openclaw/pull/17279.diff",
    "patch_url": "https://github.com/openclaw/openclaw/pull/17279.patch",
    "merged_at": null
  },
  "body": "## Summary\n\nRestores the token priority to storedToken ?? this.opts.token, fixing the device token auth regression in v2026.2.14. Previously paired devices now correctly authenticate via their stored device tokens instead of the shared config token.\n\n## Changes\n\n- Changed token priority in src/gateway/client.ts from this.opts.token ?? storedToken back to storedToken ?? this.opts.token\n- Added canFallbackToShared boolean to track when both stored and config tokens are available\n- Restored self-healing mechanism in catch handler that clears stale device tokens on connection failure\n- Added clearDeviceAuthToken import\n\n## Testing\n\n- TypeScript compilation passes (pnpm tsgo)\n- Gateway tests pass (1 pre-existing unrelated failure in server-runtime-config.test.ts)\n\nFixes openclaw/openclaw#17270\n\n<!-- greptile_comment -->\n\n<h3>Greptile Summary</h3>\n\nThis PR correctly restores the device token authentication priority that was broken in v2026.2.14. The changes revert a regression where config tokens incorrectly took priority over device-specific stored tokens.\n\n- Restored `storedToken ?? this.opts.token` priority ordering (line 197), ensuring paired devices use their device-specific tokens first\n- Re-added `canFallbackToShared` boolean to track when both token types are available\n- Restored self-healing mechanism that clears stale device tokens on connection failure, allowing fallback to shared config token\n- Added `clearDeviceAuthToken` import that was removed in the regression\n\nThe implementation matches the pre-regression code exactly and restores the intended authentication behavior for paired devices.\n\n<h3>Confidence Score: 5/5</h3>\n\n- This PR is safe to merge with no issues found\n- The changes directly restore the exact code that existed before the regression (commit c8b198ab), verified by comparing git history. The PR only touches authentication token priority logic in a single file, tests pass, and the implementation correctly restores device-specific token priority over shared config tokens. The self-healing mechanism for clearing stale tokens is also properly restored.\n- No files require special attention\n\n<sub>Last reviewed commit: 0f8262b</sub>\n\n<!-- greptile_other_comments_section -->\n\n<!-- /greptile_comment -->",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/openclaw/openclaw/issues/17279/reactions",
    "total_count": 1,
    "+1": 1,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/openclaw/openclaw/issues/17279/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
