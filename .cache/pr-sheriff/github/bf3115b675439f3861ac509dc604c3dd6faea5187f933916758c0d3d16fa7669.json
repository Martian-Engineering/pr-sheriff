{
  "url": "https://api.github.com/repos/openclaw/openclaw/issues/11452",
  "repository_url": "https://api.github.com/repos/openclaw/openclaw",
  "labels_url": "https://api.github.com/repos/openclaw/openclaw/issues/11452/labels{/name}",
  "comments_url": "https://api.github.com/repos/openclaw/openclaw/issues/11452/comments",
  "events_url": "https://api.github.com/repos/openclaw/openclaw/issues/11452/events",
  "html_url": "https://github.com/openclaw/openclaw/issues/11452",
  "id": 3911182048,
  "node_id": "I_kwDOQb6kR87pH-bg",
  "number": 11452,
  "title": "Cron: kind:\"at\" jobs with non-\"ok\" terminal status loop forever at 100% CPU",
  "user": {
    "login": "kikemarti-eu",
    "id": 204003604,
    "node_id": "U_kgDODCjZFA",
    "avatar_url": "https://avatars.githubusercontent.com/u/204003604?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/kikemarti-eu",
    "html_url": "https://github.com/kikemarti-eu",
    "followers_url": "https://api.github.com/users/kikemarti-eu/followers",
    "following_url": "https://api.github.com/users/kikemarti-eu/following{/other_user}",
    "gists_url": "https://api.github.com/users/kikemarti-eu/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/kikemarti-eu/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/kikemarti-eu/subscriptions",
    "organizations_url": "https://api.github.com/users/kikemarti-eu/orgs",
    "repos_url": "https://api.github.com/users/kikemarti-eu/repos",
    "events_url": "https://api.github.com/users/kikemarti-eu/events{/privacy}",
    "received_events_url": "https://api.github.com/users/kikemarti-eu/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "labels": [],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "tyler6204",
    "id": 64381258,
    "node_id": "MDQ6VXNlcjY0MzgxMjU4",
    "avatar_url": "https://avatars.githubusercontent.com/u/64381258?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tyler6204",
    "html_url": "https://github.com/tyler6204",
    "followers_url": "https://api.github.com/users/tyler6204/followers",
    "following_url": "https://api.github.com/users/tyler6204/following{/other_user}",
    "gists_url": "https://api.github.com/users/tyler6204/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tyler6204/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tyler6204/subscriptions",
    "organizations_url": "https://api.github.com/users/tyler6204/orgs",
    "repos_url": "https://api.github.com/users/tyler6204/repos",
    "events_url": "https://api.github.com/users/tyler6204/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tyler6204/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "tyler6204",
      "id": 64381258,
      "node_id": "MDQ6VXNlcjY0MzgxMjU4",
      "avatar_url": "https://avatars.githubusercontent.com/u/64381258?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tyler6204",
      "html_url": "https://github.com/tyler6204",
      "followers_url": "https://api.github.com/users/tyler6204/followers",
      "following_url": "https://api.github.com/users/tyler6204/following{/other_user}",
      "gists_url": "https://api.github.com/users/tyler6204/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tyler6204/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tyler6204/subscriptions",
      "organizations_url": "https://api.github.com/users/tyler6204/orgs",
      "repos_url": "https://api.github.com/users/tyler6204/repos",
      "events_url": "https://api.github.com/users/tyler6204/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tyler6204/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2026-02-07T20:40:31Z",
  "updated_at": "2026-02-08T03:50:14Z",
  "closed_at": "2026-02-08T03:50:14Z",
  "author_association": "NONE",
  "type": null,
  "active_lock_reason": null,
  "sub_issues_summary": {
    "total": 0,
    "completed": 0,
    "percent_completed": 0
  },
  "issue_dependencies_summary": {
    "blocked_by": 0,
    "total_blocked_by": 0,
    "blocking": 0,
    "total_blocking": 0
  },
  "body": "## Summary\n\nOne-shot cron jobs (`kind: \"at\"`) that complete with a non-`\"ok\"` status (e.g., `\"skipped\"`, `\"error\"`) are never disabled. This causes `computeJobNextRunAtMs()` to keep returning the past scheduled time, which triggers a `setTimeout(..., 0)` tight loop that pegs the gateway at 100%+ CPU indefinitely.\n\n## Environment\n\n- **OpenClaw version:** 2026.2.6-3\n- **OS:** Raspberry Pi OS (Linux 6.12.62+rpt-rpi-2712, aarch64)\n- **Install method:** npm global\n\n## Steps to Reproduce\n\n1. Create a one-shot cron job scheduled for a time in the near future:\n   ```json\n   {\n     \"name\": \"test-reminder\",\n     \"schedule\": {\"kind\": \"at\", \"atMs\": <timestamp_2_minutes_from_now>},\n     \"sessionTarget\": \"isolated\",\n     \"wakeMode\": \"now\",\n     \"payload\": {\"kind\": \"systemEvent\", \"text\": \"test\"}\n   }\n   ```\n\n2. Wait for the scheduled time to pass\n\n3. If the job completes with `lastStatus: \"skipped\"` (or any status other than `\"ok\"`), the loop begins\n\n## Expected Behavior\n\n- `kind: \"at\"` jobs should be disabled after **any** terminal execution — whether `\"ok\"`, `\"skipped\"`, or `\"error\"`\n- At minimum, there should be a retry cap or exponential backoff for past-due one-shot jobs\n\n## Actual Behavior\n\nThe job stays `enabled: true` and enters an infinite tight loop:\n\n1. `armTimer()` → `nextWakeAtMs()` returns past time → `setTimeout(fn, 0)` (fires immediately)\n2. `onTimer()` → executes job → status is `\"skipped\"` → `nextRunAtMs` recomputed to same past time\n3. `armTimer()` again → goto 1\n\nThis repeats ~4,800 times/second, driving the gateway to 100%+ CPU.\n\n## Evidence\n\n### CPU Profile (`--cpu-prof`, 105-second capture)\n\nTop functions by sample count during the busy loop:\n\n| Function | % of samples | Source |\n|----------|-------------|--------|\n| `croner.js` (g, C, partToArray) | ~16% | Schedule evaluation |\n| `json5/parse.js` (lex, string, push) | ~6% | `loadCronStore` |\n| `saveCronStore` | ~2% | Writing jobs.json |\n| `loadCronStore` | ~1.6% | Reading jobs.json |\n| File I/O (copyFile, rename, stat) | ~5% | Per-iteration persistence |\n| **Idle** | **38.6%** | Should be ~99% at rest |\n\n### strace confirmation\n\nThe loop manifests as ~5,200 reads/second on an eventfd (io_uring completion):\n```\nread(19, \"\\1\\0\\0\\0\\0\\0\\0\\0\", 8) = 8   # repeated thousands of times/sec\n```\n\nThe eventfd activity is driven by the constant file I/O from `saveCronStore`/`loadCronStore` on every iteration.\n\n### Before/After\n\n| State | CPU usage |\n|-------|-----------|\n| With stuck job | ~116% (single core pegged) |\n| After removing job | ~3% (normal idle: Telegram polling + heartbeat) |\n\n## Root Cause\n\nIn the cron timer logic, `kind: \"at\"` jobs are only auto-disabled when `status === \"ok\"`. The relevant logic (pseudocode from bundled source):\n\n```js\n// After job execution:\nif (job.schedule.kind === \"at\" && lastStatus === \"ok\") {\n  job.enabled = false;  // ← only disables on \"ok\"\n}\n\n// Next run calculation:\nif (job.schedule.kind === \"at\" && job.enabled) {\n  return job.schedule.atMs;  // ← returns the original (past) time\n}\n```\n\nSince `\"skipped\"` ≠ `\"ok\"`, the job remains enabled. `computeJobNextRunAtMs()` returns the original `atMs` (which is in the past), causing `setTimeout` to fire with delay 0 on every cycle.\n\n## Suggested Fix\n\n```js\n// Disable kind:\"at\" jobs on ANY terminal status, not just \"ok\":\nif (job.schedule.kind === \"at\") {\n  job.enabled = false;\n}\n```\n\nOr more conservatively:\n- Add a retry counter with a cap (e.g., 3 attempts)\n- Add exponential backoff for past-due one-shot jobs\n- Treat `\"skipped\"` and `\"error\"` as terminal for one-shot jobs\n\n## Impact\n\n- **Severity: High** — a single stuck job silently pegs an entire CPU core\n- In our case, the job ran undetected for 4+ days at 100% CPU on a Raspberry Pi 5, causing significant NVMe write amplification and heat\n- The only fix is manual removal of the stuck job from `cron/jobs.json`\n\n## Workaround\n\nIdentify and remove (or disable) stuck one-shot jobs:\n```bash\n# Find enabled at-jobs with nextRunAtMs in the past:\nopenclaw cron list --all --json | jq '[.[] | select(.schedule.kind == \"at\" and .enabled == true and .state.nextRunAtMs < (now * 1000))]'\n```\n\n## Related Issues\n\n- #11438 — Same infinite loop mechanism, triggered by model rejection errors\n- #8298 — Case 2 describes the same \"skipped\" loop behavior\n- #6483 — Previous cron bug (enabled default), fixed in v2026.2.6",
  "closed_by": {
    "login": "tyler6204",
    "id": 64381258,
    "node_id": "MDQ6VXNlcjY0MzgxMjU4",
    "avatar_url": "https://avatars.githubusercontent.com/u/64381258?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tyler6204",
    "html_url": "https://github.com/tyler6204",
    "followers_url": "https://api.github.com/users/tyler6204/followers",
    "following_url": "https://api.github.com/users/tyler6204/following{/other_user}",
    "gists_url": "https://api.github.com/users/tyler6204/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tyler6204/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tyler6204/subscriptions",
    "organizations_url": "https://api.github.com/users/tyler6204/orgs",
    "repos_url": "https://api.github.com/users/tyler6204/repos",
    "events_url": "https://api.github.com/users/tyler6204/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tyler6204/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/openclaw/openclaw/issues/11452/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/openclaw/openclaw/issues/11452/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed",
  "pinned_comment": null
}
