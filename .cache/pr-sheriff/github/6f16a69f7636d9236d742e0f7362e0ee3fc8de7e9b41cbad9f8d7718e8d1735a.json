{
  "url": "https://api.github.com/repos/openclaw/openclaw/issues/2036",
  "repository_url": "https://api.github.com/repos/openclaw/openclaw",
  "labels_url": "https://api.github.com/repos/openclaw/openclaw/issues/2036/labels{/name}",
  "comments_url": "https://api.github.com/repos/openclaw/openclaw/issues/2036/comments",
  "events_url": "https://api.github.com/repos/openclaw/openclaw/issues/2036/events",
  "html_url": "https://github.com/openclaw/openclaw/issues/2036",
  "id": 3854268551,
  "node_id": "I_kwDOQb6kR87lu3iH",
  "number": 2036,
  "title": "OAuth token refresh race condition with Claude Code CLI",
  "user": {
    "login": "punkhop",
    "id": 1851839,
    "node_id": "MDQ6VXNlcjE4NTE4Mzk=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1851839?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/punkhop",
    "html_url": "https://github.com/punkhop",
    "followers_url": "https://api.github.com/users/punkhop/followers",
    "following_url": "https://api.github.com/users/punkhop/following{/other_user}",
    "gists_url": "https://api.github.com/users/punkhop/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/punkhop/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/punkhop/subscriptions",
    "organizations_url": "https://api.github.com/users/punkhop/orgs",
    "repos_url": "https://api.github.com/users/punkhop/repos",
    "events_url": "https://api.github.com/users/punkhop/events{/privacy}",
    "received_events_url": "https://api.github.com/users/punkhop/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "labels": [
    {
      "id": 9706244967,
      "node_id": "LA_kwDOQb6kR88AAAACQomLZw",
      "url": "https://api.github.com/repos/openclaw/openclaw/labels/bug",
      "name": "bug",
      "color": "d73a4a",
      "default": true,
      "description": "Something isn't working"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [],
  "milestone": null,
  "comments": 2,
  "created_at": "2026-01-26T02:24:17Z",
  "updated_at": "2026-01-27T14:31:20Z",
  "closed_at": "2026-01-27T14:31:20Z",
  "author_association": "NONE",
  "type": null,
  "active_lock_reason": null,
  "sub_issues_summary": {
    "total": 0,
    "completed": 0,
    "percent_completed": 0
  },
  "issue_dependencies_summary": {
    "blocked_by": 0,
    "total_blocked_by": 0,
    "blocking": 0,
    "total_blocking": 0
  },
  "body": "## Problem\n\nWhen Claude Code (CLI) refreshes its OAuth tokens, clawdbot's stored refresh token becomes invalid, causing refresh failures with:\n\n```\nOAuth token refresh failed for anthropic: Failed to refresh OAuth token for anthropic. Please try again or re-authenticate.\n```\n\n## Root Cause\n\nOAuth refresh tokens are **single-use**. When Claude Code refreshes its tokens (getting new access + refresh tokens), the old refresh token that clawdbot has stored is invalidated by Anthropic.\n\n### Timeline of failure:\n\n1. Both Claude Code and clawdbot share the same OAuth credentials initially\n2. Token expires at time H\n3. Claude Code refreshes at H-5min → gets NEW access + refresh tokens, writes to keychain\n4. Clawdbot still has OLD tokens, but `syncExternalCliCredentials()` doesn't run because `isExternalProfileFresh()` returns true (token has >10min left according to clawdbot's stale expiry time)\n5. At time H, clawdbot's stored token expires\n6. Clawdbot tries to refresh using its OLD refresh token → **fails** (token was invalidated in step 3)\n7. Only now does clawdbot try to sync from keychain, but the refresh already failed\n\n### Relevant code\n\n- `EXTERNAL_CLI_NEAR_EXPIRY_MS = 10 * 60 * 1000` (10 minutes) - sync only triggers within this window\n- `syncExternalCliCredentials()` in `src/agents/auth-profiles/external-cli-sync.ts`\n- `resolveApiKeyForProfile()` in `src/agents/auth-profiles/oauth.ts`\n\n## Suggested Fixes\n\n### Option 1: Sync before refresh (recommended)\nIn `refreshOAuthTokenWithLock()`, before attempting refresh, check if Claude Code keychain has fresher tokens:\n\n```typescript\n// Before calling refreshAnthropicToken(), check keychain\nconst keychainCreds = readClaudeCliCredentials();\nif (keychainCreds?.type === 'oauth' && keychainCreds.expires > Date.now()) {\n  // Use keychain tokens instead of refreshing\n  return { apiKey: keychainCreds.access, newCredentials: keychainCreds };\n}\n```\n\n### Option 2: Retry after refresh failure\nIn the catch block of `resolveApiKeyForProfile()`, after refresh fails, try syncing from keychain and retry once.\n\n### Option 3: More aggressive sync\nReduce `EXTERNAL_CLI_NEAR_EXPIRY_MS` or sync on every token resolution (with a short TTL cache).\n\n## Workaround\n\nManually sync tokens by copying from Claude Code keychain to clawdbot's auth-profiles.json:\n\n```bash\n# Read fresh tokens from keychain\nsecurity find-generic-password -s \"Claude Code-credentials\" -w\n\n# Update ~/.clawdbot/agents/main/agent/auth-profiles.json with fresh tokens\n```\n\nOr restart clawdbot gateway after Claude Code has refreshed.\n\n## Environment\n\n- clawdbot version: 2026.1.24-3\n- macOS 26.2\n- Claude Code storing credentials in macOS Keychain",
  "closed_by": {
    "login": "sebslight",
    "id": 19554889,
    "node_id": "MDQ6VXNlcjE5NTU0ODg5",
    "avatar_url": "https://avatars.githubusercontent.com/u/19554889?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/sebslight",
    "html_url": "https://github.com/sebslight",
    "followers_url": "https://api.github.com/users/sebslight/followers",
    "following_url": "https://api.github.com/users/sebslight/following{/other_user}",
    "gists_url": "https://api.github.com/users/sebslight/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/sebslight/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/sebslight/subscriptions",
    "organizations_url": "https://api.github.com/users/sebslight/orgs",
    "repos_url": "https://api.github.com/users/sebslight/repos",
    "events_url": "https://api.github.com/users/sebslight/events{/privacy}",
    "received_events_url": "https://api.github.com/users/sebslight/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/openclaw/openclaw/issues/2036/reactions",
    "total_count": 1,
    "+1": 1,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/openclaw/openclaw/issues/2036/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
