{
  "url": "https://api.github.com/repos/openclaw/openclaw/issues/8140",
  "repository_url": "https://api.github.com/repos/openclaw/openclaw",
  "labels_url": "https://api.github.com/repos/openclaw/openclaw/issues/8140/labels{/name}",
  "comments_url": "https://api.github.com/repos/openclaw/openclaw/issues/8140/comments",
  "events_url": "https://api.github.com/repos/openclaw/openclaw/issues/8140/events",
  "html_url": "https://github.com/openclaw/openclaw/issues/8140",
  "id": 3892183588,
  "node_id": "I_kwDOQb6kR87n_gIk",
  "number": 8140,
  "title": "[Bug]: Telegram Channel Issues",
  "user": {
    "login": "atomtanstudio",
    "id": 253625110,
    "node_id": "U_kgDODx4DFg",
    "avatar_url": "https://avatars.githubusercontent.com/u/253625110?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/atomtanstudio",
    "html_url": "https://github.com/atomtanstudio",
    "followers_url": "https://api.github.com/users/atomtanstudio/followers",
    "following_url": "https://api.github.com/users/atomtanstudio/following{/other_user}",
    "gists_url": "https://api.github.com/users/atomtanstudio/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/atomtanstudio/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/atomtanstudio/subscriptions",
    "organizations_url": "https://api.github.com/users/atomtanstudio/orgs",
    "repos_url": "https://api.github.com/users/atomtanstudio/repos",
    "events_url": "https://api.github.com/users/atomtanstudio/events{/privacy}",
    "received_events_url": "https://api.github.com/users/atomtanstudio/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "labels": [
    {
      "id": 9706244967,
      "node_id": "LA_kwDOQb6kR88AAAACQomLZw",
      "url": "https://api.github.com/repos/openclaw/openclaw/labels/bug",
      "name": "bug",
      "color": "d73a4a",
      "default": true,
      "description": "Something isn't working"
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [],
  "milestone": null,
  "comments": 2,
  "created_at": "2026-02-03T16:47:32Z",
  "updated_at": "2026-02-03T17:22:21Z",
  "closed_at": null,
  "author_association": "NONE",
  "type": null,
  "active_lock_reason": null,
  "sub_issues_summary": {
    "total": 0,
    "completed": 0,
    "percent_completed": 0
  },
  "issue_dependencies_summary": {
    "blocked_by": 0,
    "total_blocked_by": 0,
    "blocking": 0,
    "total_blocking": 0
  },
  "body": "Summary:\n\nTwo related issues with the Telegram channel:\n\nDuplicate message delivery after gateway restart via SIGUSR1\nNo auto-recovery when Telegram channel exits due to getUpdates timeout\nEnvironment\nOpenClaw version: 2026.2.1 (ed4529e)\nNode.js: v22.22.0\nOS: macOS (Darwin 25.2.0 arm64)\nTelegram transport: grammY long-polling\nIssue 1: Duplicate Message Delivery\nDescription\nAfter a gateway restart (via config.apply which sends SIGUSR1), Telegram messages are delivered twice to the agent with the same message_id.\n\nSteps to Reproduce\nHave Telegram channel running normally\nTrigger a config change that causes gateway restart (SIGUSR1)\nSend a message via Telegram\nObserve the message arriving twice with identical message_id\nExpected Behavior\nEach Telegram message should be delivered exactly once, deduplicated by message_id.\n\nActual Behavior\nMessages arrive twice. The inbound dedupe cache (documented in concepts/messages.md) appears to either:\n\nBe cleared on provider restart\nHave too short a TTL\nNot be checked before the message is enqueued\nRelevant Log Pattern\n2026-02-03T15:10:53.840Z [gateway] signal SIGUSR1 received\n2026-02-03T15:10:53.841Z [gateway] received SIGUSR1; restarting\n2026-02-03T15:10:54.480Z [telegram] [default] starting provider (@botname)\n2026-02-03T15:10:55.312Z [gateway] signal SIGUSR1 received  <-- Second SIGUSR1 within 1 second\n2026-02-03T15:10:55.314Z [gateway] received SIGUSR1; restarting\n2026-02-03T15:10:55.669Z [telegram] [default] starting provider (@botname)\nThe Telegram provider restarted twice within ~1 second. Messages sent shortly after were delivered twice.\n\nIssue 2: No Auto-Recovery After Channel Exit\nDescription\nWhen the Telegram channel exits due to a getUpdates timeout, it does not automatically restart. The channel remains dead until a manual gateway restart.\n\nSteps to Reproduce\nHave Telegram channel running with long-polling\nWait for a getUpdates timeout (500 seconds default)\nObserve channel exit in logs\nNote that channel does not restart automatically\nExpected Behavior\nWhen the Telegram channel exits (for any reason), it should automatically attempt to restart with backoff.\n\nActual Behavior\nChannel exits and stays dead. In this case, the channel was down for ~6 hours until a manual config.apply restarted the gateway.\n\nTimeline from Logs\n2026-02-03T08:56:30.732Z [telegram] [default] starting provider (@botname)  <-- Last successful start\n2026-02-03T09:16:40.598Z [telegram] [default] channel exited: Request to 'getUpdates' timed out after 500 seconds\n                        <-- No restart attempts for ~6 hours -->\n2026-02-03T15:10:54.480Z [telegram] [default] starting provider (@botname)  <-- Manual restart via config.apply\nContributing Factor\nDuring the outage period, there were also repeated FailoverError: No API key found for provider \"xai\" errors (a misconfigured model fallback). This may have contributed to system instability, though the channel should still auto-recover regardless.\n\nSanitized Logs\ngateway.log (relevant sections)\n# Frequent restarts before the crash (many config changes during setup)\n2026-02-03T08:15:07.699Z [telegram] [default] starting provider (@botname)\n2026-02-03T08:28:40.584Z [telegram] [default] starting provider (@botname)\n2026-02-03T08:28:49.417Z [telegram] [default] starting provider (@botname)\n2026-02-03T08:29:14.952Z [telegram] [default] starting provider (@botname)\n2026-02-03T08:31:47.599Z [telegram] [default] starting provider (@botname)\n2026-02-03T08:37:28.024Z [telegram] [default] starting provider (@botname)\n2026-02-03T08:45:24.938Z [telegram] [default] starting provider (@botname)\n2026-02-03T08:47:40.517Z [telegram] [default] starting provider (@botname)\n2026-02-03T08:55:05.487Z [telegram] [default] starting provider (@botname)\n2026-02-03T08:55:06.672Z [telegram] [default] starting provider (@botname)  # <-- 1 second apart\n2026-02-03T08:56:29.236Z [telegram] [default] starting provider (@botname)\n2026-02-03T08:56:30.732Z [telegram] [default] starting provider (@botname)  # <-- 1 second apart, last before crash\n\n# 6+ hour gap - no telegram activity\n\n2026-02-03T15:10:54.480Z [telegram] [default] starting provider (@botname)  # Manual restart\n2026-02-03T15:10:55.669Z [telegram] [default] starting provider (@botname)  # <-- 1 second apart (duplicates started here)\n2026-02-03T15:31:18.037Z [telegram] [default] starting provider (@botname)\ngateway.err.log (relevant sections)\n# xAI errors (misconfigured fallback model without API key)\n2026-02-03T08:49:31.665Z [diagnostic] lane task error: lane=main durationMs=2 error=\"FailoverError: No API key found for provider \"xai\"...\"\n2026-02-03T08:54:40.836Z [diagnostic] lane task error: lane=main durationMs=1 error=\"FailoverError: No API key found for provider \"xai\"...\"\n2026-02-03T08:55:09.685Z [diagnostic] lane task error: lane=main durationMs=1 error=\"FailoverError: No API key found for provider \"xai\"...\"\n2026-02-03T08:55:32.483Z [diagnostic] lane task error: lane=main durationMs=1 error=\"FailoverError: No API key found for provider \"xai\"...\"\n2026-02-03T08:56:33.870Z [diagnostic] lane task error: lane=main durationMs=1 error=\"FailoverError: No API key found for provider \"xai\"...\"\n\n# THE CRASH - Telegram channel exits and never recovers\n2026-02-03T09:16:40.598Z [telegram] [default] channel exited: Request to 'getUpdates' timed out after 500 seconds\n2026-02-03T09:16:40.600Z [openclaw] Suppressed AbortError: AbortError: This operation was aborted\n\n# xAI errors continue during outage (heartbeats still running)\n2026-02-03T10:08:05.653Z [diagnostic] lane task error: lane=main durationMs=1 error=\"FailoverError: No API key found for provider \"xai\"...\"\n2026-02-03T11:14:31.665Z [diagnostic] lane task error: lane=main durationMs=1 error=\"FailoverError: No API key found for provider \"xai\"...\"\nSuggested Fixes\nFor Issue 1 (Duplicates)\nPersist the dedupe cache across provider restarts (or use a longer TTL)\nAlternatively, track lastUpdateId more carefully and ensure updates aren't re-fetched after restart\nConsider debouncing rapid SIGUSR1 signals to avoid double-restart scenarios\nFor Issue 2 (No Auto-Recovery)\nAdd auto-restart logic when the Telegram channel exits\nImplement exponential backoff for restart attempts\nLog a warning when channel has been down for extended periods\nConsider a health check that detects dead channels and restarts them\nConfiguration (sanitized)\n{\n  channels: {\n    telegram: {\n      enabled: true,\n      botToken: \"<redacted>\",\n      dmPolicy: \"pairing\",\n      groupPolicy: \"allowlist\",\n      streamMode: \"partial\"\n    }\n  }\n}\nNo custom timeout or retry settings were configured.",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/openclaw/openclaw/issues/8140/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/openclaw/openclaw/issues/8140/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
